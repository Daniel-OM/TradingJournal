{% extends "base.html" %}

{% block title %}Análisis de Errores - Trading Journal{% endblock %}

{% block style %}
<style>
    .page-header {
        background: var(--gradient-primary);
        color: white;
        padding: 30px;
        border-radius: var(--border-radius);
        margin-bottom: 30px;
        position: relative;
        overflow: hidden;
    }

    .page-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 100" fill="rgba(255,255,255,0.1)"><polygon points="0,0 1000,100 1000,0"/></svg>');
        background-size: cover;
    }

    .page-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 10px;
        position: relative;
        z-index: 1;
    }

    .page-header p {
        font-size: 1.1rem;
        opacity: 0.9;
        margin-bottom: 20px;
        position: relative;
        z-index: 1;
    }

    .header-actions {
        position: relative;
        z-index: 1;
    }

    .btn-modern {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 12px 24px;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .btn-modern:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-lg);
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--gradient-primary);
    }

    .stat-card.danger::before {
        background: var(--gradient-danger);
    }

    .stat-card.success::before {
        background: var(--gradient-success);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 8px;
        background: var(--gradient-primary);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card.danger .stat-number {
        background: var(--gradient-danger);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-card.success .stat-number {
        background: var(--gradient-success);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        color: #6b7280;
        font-size: 0.95rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-icon {
        position: absolute;
        top: 20px;
        right: 20px;
        font-size: 2rem;
        opacity: 0.1;
    }

    .chart-container {
        position: relative;
        margin: 20px 0;
        border: 2px solid #ddd;
        border-radius: 5px;
        padding: 10px;
    }
    .chart-fixed {
        height: 200px; /* Altura fija del contenedor */
    }

    .filter-section {
        background: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: 30px;
        border: 1px solid rgba(0, 0, 0, 0.1);
    }

    .filter-title {
        display: flex;
        align-items: center;
        margin-bottom: 20px;
        color: var(--dark-color);
        font-weight: 600;
    }

    .filter-title i {
        margin-right: 10px;
        color: var(--primary-color);
    }

    .filter-controls {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        align-items: end;
    }

    .filter-group label {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 8px;
        display: block;
    }

    .form-control, .form-select {
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px 16px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: white;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        outline: none;
    }

    .error-card {
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
        margin-bottom: 20px;
        padding: 25px;
        border-left: 5px solid var(--danger-color);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .error-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-lg);
    }

    .error-card::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 100px;
        height: 100px;
        background: radial-gradient(circle, rgba(239, 68, 68, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(30px, -30px);
    }

    .error-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
        position: relative;
        z-index: 1;
    }

    .error-title {
        color: var(--danger-color);
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0;
        flex: 1;
        margin-right: 15px;
    }

    .error-count {
        background: var(--gradient-danger);
        color: white;
        border-radius: 50px;
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 700;
        box-shadow: var(--shadow-sm);
        position: relative;
        z-index: 1;
    }

    .error-trades {
        background: rgba(239, 68, 68, 0.05);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
        border-left: 3px solid var(--danger-color);
    }

    .error-trades strong {
        color: var(--danger-color);
        font-size: 0.9rem;
    }

    .error-details {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e5e7eb;
    }

    .last-occurrence {
        color: #6b7280;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
    }

    .last-occurrence i {
        margin-right: 5px;
        color: var(--info-color);
    }

    .error-frequency {
        background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.85rem;
        color: var(--dark-color);
        font-weight: 600;
        box-shadow: var(--shadow-sm);
    }

    .error-actions {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    .btn-action {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid rgba(99, 102, 241, 0.2);
        color: var(--primary-color);
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
    }

    .btn-action:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
    }

    .btn-action i {
        margin-right: 5px;
    }

    .severity-high {
        border-left-color: var(--danger-color);
    }

    .severity-medium {
        border-left-color: var(--warning-color);
    }

    .severity-low {
        border-left-color: var(--success-color);
    }

    .no-errors {
        text-align: center;
        padding: 80px 20px;
        background: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-md);
    }

    .no-errors i {
        font-size: 4rem;
        color: var(--success-color);
        margin-bottom: 20px;
        display: block;
    }

    .no-errors h3 {
        color: var(--success-color);
        margin-bottom: 15px;
        font-weight: 700;
    }

    .pagination {
        margin-top: 30px;
    }

    .page-link {
        border: none;
        color: var(--primary-color);
        padding: 12px 16px;
        margin: 0 2px;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .page-link:hover {
        background: var(--primary-color);
        color: white;
        transform: translateY(-1px);
    }

    .page-item.active .page-link {
        background: var(--primary-color);
        border-color: var(--primary-color);
    }

    .modal-content {
        border: none;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
    }

    .modal-header {
        background: var(--gradient-primary);
        color: white;
        border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .btn-close {
        filter: invert(1);
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 20px;
    }

    .spinner-border {
        color: var(--primary-color);
    }

    @media (max-width: 768px) {
        .main-container {
            margin: 10px;
            padding: 20px;
        }

        .page-header h1 {
            font-size: 2rem;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .filter-controls {
            grid-template-columns: 1fr;
        }

        .error-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .error-count {
            margin-top: 10px;
        }

        .error-details {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .error-actions {
            flex-direction: column;
        }

        .btn-action {
            justify-content: center;
        }
    }

    .animate-fade-in {
        animation: fadeIn 0.6s ease-out;
    }

    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .animate-slide-up {
        animation: slideUp 0.4s ease-out;
    }

    @keyframes slideUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}

    <div class="main-container animate-fade-in">
        <!-- TODO: Chart with the daily errors carried out and the average over the last x days. 
         Also the average quantity of errors per trade. To follow closely the traders improvement. -->
        <!-- Header -->
        <div class="page-header">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1>
                        <i class="fas fa-exclamation-triangle me-3"></i>
                        Análisis de Errores
                    </h1>
                    <p class="mb-0">Identifica patrones y mejora tu estrategia de trading</p>
                </div>
                <div class="header-actions">
                    <a href="{{ url_for('journal_endpoints.journal') }}" class="btn btn-modern me-2">
                        <i class="fas fa-book me-2"></i>Volver al Diario
                    </a>
                    <button class="btn btn-modern" onclick="exportErrors()">
                        <i class="fas fa-download me-2"></i>Exportar
                    </button>
                </div>
            </div>
        </div>

        <!-- Estadísticas Generales -->
        <div class="stats-grid animate-slide-up">
            <div class="stat-card danger">
                <div class="stat-number">{{ total_errors }}</div>
                <div class="stat-label">Errors Types</div>
                <i class="fas fa-exclamation-triangle stat-icon"></i>
            </div>
            <div class="stat-card danger">
                <div class="stat-number">{{ total_occurrences }}</div>
                <div class="stat-label">Total Ocurrencies</div>
                <i class="fas fa-chart-line stat-icon"></i>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ "%.2f"|format(avg_per_error) }}</div>
                <div class="stat-label">Average Ocurrencies per Error</div>
                <i class="fas fa-calculator stat-icon"></i>
            </div>
            <div class="stat-card success">
                <div class="stat-number">{{ days_since_last }}</div>
                <div class="stat-label">Days Since Last</div>
                <i class="fas fa-calendar-check stat-icon"></i>
            </div>
        </div>

        <!-- Filtros -->
        <div class="filter-section animate-slide-up">
            <h5 class="filter-title">
                <i class="fas fa-filter"></i>
                Filters and settings
            </h5>
            <form method="GET" class="filter-controls">
                <div class="filter-group">
                    <label>Analysis period</label>
                    <select name="period" class="form-select" onchange="this.form.submit()">
                        <option value="all" {{ 'selected' if period == 'all' else '' }}>Any time</option>
                        <option value="30" {{ 'selected' if period == '30' else '' }}>Last 30 days</option>
                        <option value="90" {{ 'selected' if period == '90' else '' }}>Last 3 months</option>
                        <option value="180" {{ 'selected' if period == '180' else '' }}>Last 6 months</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Order by</label>
                    <select name="sort" class="form-select" onchange="this.form.submit()">
                        <option value="frequency" {{ 'selected' if sort == 'frequency' else '' }}>Frequency</option>
                        <option value="recent" {{ 'selected' if sort == 'recent' else '' }}>Most recent</option>
                        <option value="alphabetical" {{ 'selected' if sort == 'alphabetical' else '' }}>Alphabetic</option>
                        <option value="impact" {{ 'selected' if sort == 'impact' else '' }}>Economic impact</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Minimum ocurrencies</label>
                    <input type="number" name="min_count" value="{{ min_count if min_count else 1 }}" class="form-control" min="1" onchange="this.form.submit()">
                </div>
                <div class="filter-group">
                    <label>Severity</label>
                    <select name="severity" class="form-select" onchange="this.form.submit()">
                        <option value="all" {{ 'selected' if severity == 'all' else '' }}>All severities</option>
                        <option value="high" {{ 'selected' if severity == 'higha' else '' }}>High</option>
                        <option value="medium" {{ 'selected' if severity == 'medium' else '' }}>Medium</option>
                        <option value="low" {{ 'selected' if severity == 'low' else '' }}>Low</option>
                    </select>
                </div>
            </form>
        </div>

        <!-- Lista de Errores -->
        <div class="row errors-list animate-slide-up">
            {% for error in errors %}
            <div class="col col-md-6 mb-3">
                <div class="error-card severity-{{error['severity']}}">
                    <div class="error-header">
                        <h3 class="error-title">{{ error['description'] }}</h3>
                        <span class="error-count">{{ error['count'] }} ocurrencies</span>
                    </div>
                    
                    <div class="error-trades">
                        <small>
                            <strong>Ejemplos recientes:</strong>
                            {% for t in (error['trades']|sort(true, attribute='entry_date'))[:3] %}
                            {{ t['symbol'] }} ({{ t['entry_date'] }}){{ ", " if not loop.last else "" }}
                            {% endfor %}
                            {% if (error['trades']|length) > 3 %}
                            and {{ (error['trades']|length) - 3 }} more...
                            {% endif %}
                        </small>
                    </div>
                    
                    <div class="error-details">
                        <div class="last-occurrence">
                            <i class="fas fa-calendar-alt"></i>
                            Last time: {{ error['last_ocurrence'] }}
                            <span class="text-muted ms-2">({{ error['days_ago'] }} days ago)</span>
                        </div>
                        <div class="error-frequency">
                            {{ "%.2f"|format(error['frequency']*100) }}% of total
                        </div>
                    </div>
                    
                    <div class="error-actions">
                        <button class="btn-action" onclick='viewErrorDetails(`{{ error|tojson }}`)'>
                            <i class="fas fa-eye"></i>Details
                        </button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Paginación -->
        <nav aria-label="Paginación de errores" class="mt-4">
            <ul class="pagination justify-content-center">
                {% if pagination.has_prev %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('error_endpoints.errors', page=pagination.prev_num) }}" aria-label="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
                {% endif %}
                {% for page_num in pagination.iter_pages() %}
                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('error_endpoints.errors', page=page_num) }}">{{ page_num }}</a>
                </li>
                {% endfor %}
                {% if pagination.has_next %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('error_endpoints.errors', page=pagination.next_num) }}" aria-label="Next">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
    </div>
{% endblock %}

{% block modals %}

    <!-- Modal para detalles del error -->
    <div class="modal fade" id="errorDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-analytics me-2"></i>
                        Error Details
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="loading-spinner">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Analizando datos...</p>
                    </div>
                    <div id="errorDetailsContent"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn bg-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn bg-primary" onclick="generateReport()">
                        <i class="fas fa-file-alt me-1"></i>Generar Reporte
                    </button>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block scripts %}
<script>
    let chart = null; // Variable global

        function showLoading(modalId) {
            const modal = document.querySelector(`#${modalId} .loading-spinner`);
            const content = document.querySelector(`#${modalId} .modal-body > div:not(.loading-spinner)`);
            
            if (modal) modal.style.display = 'block';
            if (content) content.style.display = 'none';
        }

        function hideLoading(modalId) {
            const modal = document.querySelector(`#${modalId} .loading-spinner`);
            const content = document.querySelector(`#${modalId} .modal-body > div:not(.loading-spinner)`);
            
            if (modal) modal.style.display = 'none';
            if (content) content.style.display = 'block';
        }

        
        function chartData (datos) {
            // Obtener fecha de hace un mes
            const hoy = new Date();
            const haceUnMes = new Date();
            haceUnMes.setMonth(hoy.getMonth() - 1);

            // Filtrar datos del último mes
            const datosUltimoMes = datos.filter(item => {
                if (!item.entry_date) return false;
                const fechaItem = new Date(item.entry_date);
                return fechaItem >= haceUnMes && fechaItem <= hoy;
            });

            // Contar por fecha
            const conteosPorFecha = {};
            datosUltimoMes.forEach(item => {
                const fecha = item.entry_date;
                conteosPorFecha[fecha] = (conteosPorFecha[fecha] || 0) + 1;
            });

            // Crear array de fechas completo del último mes
            const fechasCompletas = {};
            const fechaActual = new Date(haceUnMes);

            while (fechaActual <= hoy) {
                const fechaStr = fechaActual.toISOString().split('T')[0];
                fechasCompletas[fechaStr] = conteosPorFecha[fechaStr] || 0;
                fechaActual.setDate(fechaActual.getDate() + 1);
            }

            return fechasCompletas;
        }

        function dateFormat (fechaStr) {
            const fecha = new Date(fechaStr);
            return fecha.toLocaleDateString('es-ES', {
                month: 'short',
                day: 'numeric'
            });
        }

        function createChart (element, datos) {
            if (chart) {
                chart.destroy();
            }

            const ctx = element.getContext('2d');

            const fechas = Object.keys(datos);
            const valores = Object.values(datos);

            // Actualizar estadísticas
            const totalRecords = valores.reduce((sum, val) => sum + val, 0);
            const daysWithData = valores.filter(val => val > 0).length;
            const maxDay = Math.max(...valores);
            const avgDay = Math.round(totalRecords / daysWithData) || 0;

            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: fechas.map(dateFormat),
                    datasets: [{
                        label: 'Frequency',
                        data: valores,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Frequency of ocurrence',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: 'Ocurrences'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Dates'
                            },
                            ticks: {
                                maxTicksLimit: 15,
                                maxRotation: 45
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }

        function updateChart (element, new_data) {
            if (chart) {
                chart.data.labels = new_data.labels;
                chart.data.datasets[0].data = new_data.data;
                chart.update();
            } else {
                createChart(element, new_data);
            }
        }

        // Procesar datos y crear gráfico

        function viewErrorDetails(data) {
            showLoading('errorDetailsModal');
            data = JSON.parse(data);
            // Simular carga de datos
            setTimeout(() => {
                document.getElementById('errorDetailsContent').innerHTML = `
                    
                    <div class="mb-3">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Se encontraron <strong>${data.trades.length}</strong> trades afectados por este error
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <h5 class="text-warning">${Math.abs(data.trades.reduce((sum, trade) => sum + trade.profit_loss, 0)).toFixed(2)}</h5>
                                        <small class="text-muted">Resultado total</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success">
                                    <div class="card-body text-center">
                                        <h5 class="text-success">${(data.trades.reduce((sum, trade) => trade.profit_loss > 0 ? sum + trade.profit_loss : 0, 0) / data.trades.length).toFixed(2)}</h5>
                                        <small class="text-muted">Ganancia promedio</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <h5 class="text-danger">${(data.trades.reduce((sum, trade) => trade.profit_loss < 0 ? sum + trade.profit_loss : 0, 0) / data.trades.length).toFixed(2)}</h5>
                                        <small class="text-muted">Pérdida promedio</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Evolution</h6>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="errorTrendChart"></canvas>
                                </div>
                                <p class="text-muted small mt-2 mb-0">
                                    <i class="fas fa-info-circle me-1"></i>
                                    The chart shows the frequency of the error over time
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive mt-3">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th><i class="fas fa-calendar me-1"></i>Date</th>
                                    <th><i class="fas fa-chart-line me-1"></i>Symbol</th>
                                    <th><i class="fas fa-strategy me-1"></i>Strategy</th>
                                    <th><i class="fas fa-dollar-sign me-1"></i>P&L</th>
                                    <th><i class="fas fa-cog me-1"></i></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.trades.map(trade => `
                                    <tr>
                                        <td>
                                            <span class="text-muted">${trade.entry_date}</span>
                                        </td>
                                        <td>
                                            <span class="badge bg-primary">${trade.symbol}</span>
                                        </td>
                                        <td>
                                            <small class="text-muted">${trade.strategy.description}</small>
                                        </td>
                                        <td>
                                            <span class="fw-bold ${trade.profit_loss >= 0 ? 'text-success' : 'text-danger'}">
                                                ${trade.profit_loss >= 0 ? '+' : ''}${trade.profit_loss.toFixed(2)}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="${"{{ url_for('journal_endpoints.get_trade', id=0) }}".replace('0', trade.id)}" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                createChart(document.getElementById('errorTrendChart'), 
                            chartData(data.trades));
                new bootstrap.Modal(document.getElementById('errorDetailsModal')).show();
                hideLoading('errorDetailsModal');
            }, 1000);
        }

        function exportErrors() {
            // Simular exportación
            showNotification('Exportando datos de errores...', 'info');
            
            setTimeout(() => {
                showNotification('Archivo de errores exportado exitosamente', 'success');
            }, 2000);
        }

        function analyzePattern() {
            showNotification('Iniciando análisis de patrones...', 'info');
            
            setTimeout(() => {
                showNotification('Análisis completado. Se ha enviado un reporte a tu email.', 'success');
            }, 3000);
        }

        function generateReport() {
            showNotification('Generando reporte detallado...', 'info');
            
            setTimeout(() => {
                showNotification('Reporte generado y descargado exitosamente', 'success');
            }, 2000);
        }

        // Inicializar tooltips y animaciones
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar tooltips de Bootstrap
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Animar elementos al hacer scroll
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };

            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.style.opacity = '1';
                        entry.target.style.transform = 'translateY(0)';
                    }
                });
            }, observerOptions);

            // Observar elementos para animación
            document.querySelectorAll('.error-card, .stat-card').forEach(el => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(30px)';
                el.style.transition = 'all 0.6s ease';
                observer.observe(el);
            });
        });

        // Función para manejar el cambio de filtros con loading
        document.querySelectorAll('select[onchange*="submit"], input[onchange*="submit"]').forEach(element => {
            element.addEventListener('change', function() {
                // Mostrar loading overlay
                const overlay = document.createElement('div');
                overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
                overlay.style.cssText = `
                    background: rgba(255,255,255,0.9);
                    z-index: 9998;
                    backdrop-filter: blur(5px);
                `;
                overlay.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                        <p class="text-primary fw-bold">Actualizando análisis...</p>
                    </div>
                `;
                document.body.appendChild(overlay);
                
                // Simular carga
                setTimeout(() => {
                    overlay.remove();
                    showNotification('Filtros aplicados correctamente', 'success');
                }, 1500);
            });
        });
</script>
{% endblock %}