{% extends "base.html" %}

{% block style %}
<style>
    .error-input-group, .transaction-input-group {
        margin-bottom: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card">
            <div class="card-header">
                <h4><i class="fas fa-plus me-2"></i>Registrar Nuevo Trade</h4>
            </div>
            <div class="card-body">
                <form method="POST" id="tradeForm" enctype="multipart/form-data">
                    <!-- Información básica -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Símbolo</label>
                            <input type="text" name="symbol" class="form-control" value="{{ trade.symbol if trade else '' }}" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Nombre de la Compañía</label>
                            <input type="text" name="company_name" value="{{ trade.company_name if trade else '' }}" class="form-control">
                        </div>
                    </div>
                    
                    <!-- Tipo y cantidades -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Tipo de Operación</label>
                            <select name="trade_type" class="form-select" required>
                                <option value="LONG" {% if trade and trade.trade_type == "LONG" %}selected{% endif %}>Long (Compra)</option>
                                <option value="SHORT" {% if trade and trade.trade_type == "SHORT" %}selected{% endif %}>Short (Venta)</option>
                            </select>
                        </div>
                    </div>
                    {% if trade %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Cantidad</label>
                            <input type="number" name="quantity" step="0.0000000001" class="form-control" value="{{ trade.quantity if trade else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Comisión</label>
                            <input type="number" name="commission" step="0.0000000001" class="form-control" value="{{ trade.commission if trade else '1.0' }}">
                        </div>
                    </div>
                    {% endif %}
                    <div class="mb-3">
                        <label class="form-label">Balance total</label>
                        <input type="number" name="balance" step="0.0000000001" class="form-control" value="{{ trade.balance if trade else '' }}">
                    </div>
                    {% if trade %}
                    <!-- Entrada -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Price</label>
                            <input type="number" name="entry_price" step="0.0000000001" class="form-control" value="{{ trade.entry_price if trade else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Date</label>
                            <input type="date" name="entry_date" class="form-control" value="{{ trade.entry_date if trade else date.today() }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Time</label>
                            <input type="time" name="entry_time" step="1" class="form-control" value="{{ trade.entry_time if trade else '' }}">
                        </div>
                    </div>
                    {% endif %}
                    <!-- Stop/TP -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Stop Loss</label>
                            <input type="number" name="stop_loss" step="0.0000000001" class="form-control" value="{{ trade.stop_loss if trade else '' }}">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Take Profit</label>
                            <input type="number" name="take_profit" step="0.0000000001" class="form-control" value="{{ trade.take_profit if trade else '' }}">
                        </div>
                    </div>
                    {% if trade %}
                    <!-- Salida -->
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Precio de Salida</label>
                            <input type="number" name="exit_price" step="0.0000000001" class="form-control" value="{{ trade.exit_price if trade else '' }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Fecha de Salida</label>
                            <input type="date" name="exit_date" class="form-control" value="{{ trade.exit_date if trade else date.today() }}">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">Hora de Salida</label>
                            <input type="time" name="exit_time" step="1" class="form-control" value="{{ trade.exit_time if trade else '' }}">
                        </div>
                    </div>
                    {% endif %}
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-chart-line me-2"></i>Transactions
                        </label>
                        <div class="transactions-container">
                            <div id="transactions-list">
                                <!-- Los transactiones se agregarán dinámicamente aquí -->
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-pill bg-primary" onclick="addTransaction()">
                                    <i class="fas fa-plus me-1"></i>Add transaction
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Agrega las transacciones que se hayan ejecutado en esta operación
                            </small>
                        </div>
                    </div>
                    
                    <!-- Estrategia -->
                    <div class="mb-3">
                        <label class="form-label">Estrategia Aplicada</label>
                        <select name="strategy_id" class="form-select" id="strategySelect" onchange="loadStrategyConditions()">
                            <option value="">Seleccionar estrategia</option>
                            {% for strategy in strategies %}
                                <option value="{{ strategy.id }}" {% if trade and trade.strategy_id == strategy.id %}selected{% endif %}>
                                    {{ strategy.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Sección de Condiciones de Estrategia -->
                    <div id="strategyConditions" class="conditions-section">
                        <div class="d-flex align-items-center mb-3">
                            <i class="fas fa-check-circle text-success me-2"></i>
                            <h5 class="mb-0">Condiciones de Puntuación de la Estrategia</h5>
                        </div>
                        <p class="text-muted mb-3">Marca las condiciones que se cumplen para calcular automáticamente la puntuación:</p>
                        
                        <div id="conditionsList">
                            <!-- Las condiciones se cargarán dinámicamente aquí -->
                        </div>

                        <div id="scoreDisplay" class="score-display" style="display: none;">
                            <div>Puntuación Calculada: <span id="calculatedScore">0</span>/<span id="maxScore">10</span></div>
                            <div class="score-breakdown" id="scoreBreakdown"></div>
                        </div>
                        <div class="col-md-4 mb-3 d-none">
                            <label class="form-label">Puntuación</label>
                            <input type="number" min="0" max="100" name="score" class="form-control" placeholder="7" readonly>
                            <small class="text-muted">Se calculará automáticamente según las condiciones</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Hashtags (separados por comas)</label>
                        <input type="text" name="hashtags" class="form-control" placeholder="tech, earnings, momentum" value="{{ trade.hashtags if trade else '' }}">
                    </div>

                    <!-- Sección de Errores -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">
                            <i class="fas fa-chart-line me-2"></i>Errores cometidos
                        </label>
                        <div class="errors-container">
                            <div id="errors-list">
                                <!-- Los errores se agregarán dinámicamente aquí -->
                            </div>
                            <div class="text-center mt-3">
                                <button type="button" class="btn btn-pill bg-primary" onclick="addError()">
                                    <i class="fas fa-plus me-1"></i>Add error
                                </button>
                            </div>
                            <small class="text-muted mt-2 d-block">
                                <i class="fas fa-info-circle me-1"></i>
                                Agrega los errores que se hayan cometido en esta operación
                            </small>
                        </div>
                    </div>

                    <!-- Multimedia -->
                    <div class="mb-4">
                        <label class="form-label"><i class="fas fa-image me-2"></i>Imágenes y Videos</label>
                        <div class="card shadow-none">
                            <div class="card-body mt-3">
                                <div class="mb-3">
                                    <label class="form-label">Subir Imágenes</label>
                                    <input type="file" name="images" class="form-control" multiple accept="image/*">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Subir Videos</label>
                                    <input type="file" name="videos" class="form-control" multiple accept="video/*,.mkv">
                                </div>
                                <div id="file-preview" class="mt-3"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Análisis -->
                    <div class="mb-3">
                        <label class="form-label">Descripción General</label>
                        <textarea name="description" class="form-control" rows="3">{{ trade.description if trade else '' }}</textarea>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">¿Por qué fue rentable o no?</label>
                            <textarea name="why_profitable" class="form-control" rows="3">{{ trade.why_profitable if trade else '' }}</textarea>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Factores que influyeron</label>
                            <textarea name="influencing_factors" class="form-control" rows="3">{{ trade.influencing_factors if trade else '' }}</textarea>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('journal_endpoints.journal') }}" class="btn btn-pill bg-secondary">Cancel</a>
                        <button type="submit" class="btn btn-pill bg-success">
                            <i class="fas fa-save me-2"></i>Registrar Trade
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let counter = 0;
    let tcounter = 0;
    let strategyConditions = {};
    const strategiesData = JSON.parse('{{json_strategies|tojson}}');

    // Función para manejar los combo inputs personalizados
    function initComboInputs () {
        document.querySelectorAll('.combo-input-container').forEach(container => {
            const input = container.querySelector('.combo-input');
            const dropdownBtn = container.querySelector('.combo-dropdown-btn');
            const dropdown = container.querySelector('.combo-dropdown');
            const options = container.querySelectorAll('.combo-option');

            if (!input || !dropdownBtn || !dropdown) return;

            // Toggle dropdown
            dropdownBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            });

            // Handle option selection
            options.forEach(option => {
                option.addEventListener('click', () => {
                    input.value = option.textContent;
                    let parent = container.parentElement;
                    parent.querySelector('input[name="error_id"]').value = option.dataset.value;
                    parent.querySelector(`select[name="error_category"]`).value = option.dataset.category;
                    parent.querySelector(`select[name="error_severity"]`).value = option.dataset.severity;
                    dropdown.classList.remove('show');
                });
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!container.contains(e.target)) {
                    dropdown.classList.remove('show');
                }
            });

            // Close dropdown when input loses focus (except when clicking dropdown)
            input.addEventListener('blur', (e) => {
                setTimeout(() => {
                    if (!container.contains(document.activeElement)) {
                        dropdown.classList.remove('show');
                    }
                }, 150);
            });
        });
    }

    function addError(id='', value='', category='', severity='') {
        counter++;
        const errorsList = document.getElementById('errors-list');
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-input-group';
        errorDiv.innerHTML = `
            <div class="input-group">
                <div class="combo-input-container">
                    <input type="hidden" name="error_id" value="${id}">
                    <input type="text"
                            name="error_description"
                            class="form-control combo-input"
                            placeholder="Descripción del error"
                            value="${value}"
                            required>
                    <button type="button" class="combo-dropdown-btn">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="combo-dropdown">
                        {% for error in errors %}
                            <div class="combo-option" data-value="{{error.id}}" data-category="{{error.category}}" data-severity="{{error.severity}}">{{error.description}}</div>
                        {% endfor %}
                    </div>
                </div>
                <select name="error_category" class="form-select" style="max-width: 120px;">
                    <option value="psychological" ${category == 'psychological' ? 'selected' : ''}>Psychological</option>
                    <option value="technical" ${category == 'technical' ? 'selected' : ''}>Technical</option>
                    <option value="risk_management" ${category == 'risk_management' ? 'selected' : ''}>Risk Management</option>
                    <option value="execution" ${category == 'execution' ? 'selected' : ''}>Execution</option>
                </select>
                <select name="error_severity" class="form-select" style="max-width: 120px;">
                    <option value="low" ${severity == 'low' ? 'selected' : ''}>Bajo</option>
                    <option value="medium" ${severity == 'medium' ? 'selected' : ''}>Medio</option>
                    <option value="high" ${severity == 'high' ? 'selected' : ''}>Alto</option>
                </select>
                <button type="button" class="btn btn-pill bg-danger" onclick="removeError(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        const selectedId = parseInt("{{ selected_id }}");
        if (selectedId) {
            const option = errorDiv.querySelector(`[data-value="${selectedId}"]`);
            if (option) option.classList.add('selected');
        }
        errorsList.appendChild(errorDiv);
        initComboInputs();
    }

    function removeError(button) {
        const errorDiv = button.closest('.error-input-group');
        errorDiv.remove();
    }

    
    function addTransaction(date='', time='', price='', quantity='', commission='', type='') {
        tcounter++;
        const transactionsList = document.getElementById('transactions-list');
        
        const transactionDiv = document.createElement('div');
        transactionDiv.className = 'card shadow-none transaction-input-group';
        transactionDiv.innerHTML = `
            <div class="card-body mt-3">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Fecha de Entrada</label>
                        <input type="date" name="transaction_date" class="form-control" value="${date}">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Hora de Entrada</label>
                        <input type="time" name="transaction_time" class="form-control" value="${time}" step="1">
                    </div>
                    <div class="col-md-3 mb-3">
                        <label class="form-label">Hora de Entrada</label>
                        <input type="text" name="transaction_timezone" class="form-control" value="${Intl.DateTimeFormat().resolvedOptions().timeZone}">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Precio de Entrada</label>
                        <input type="number" name="transaction_price" step="0.0000000001" class="form-control" value="${price}">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Tipo de transacción</label>
                        <select name="transaction_type" class="form-select">
                            <option value="LONG" ${type == 'LONG' ? 'selected' : ''}>Long (Compra)</option>
                            <option value="SHORT" ${type == 'SHORT' ? 'selected' : ''}>Short (Venta)</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Cantidad</label>
                        <input type="number" name="transaction_quantity" step="0.0000000001" class="form-control" value="${quantity}" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Comisión</label>
                        <input type="number" name="transaction_commission" step="0.0000000001" class="form-control" value="${commission}" required>
                    </div>
                </div>
                <button type="button" class="btn btn-pill bg-danger" onclick="removeTransaction(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        if (!transactionDiv.querySelector('input[name="transaction_date"]').valueAsDate)
            transactionDiv.querySelector('input[name="transaction_date"]').valueAsDate = new Date();
        transactionsList.appendChild(transactionDiv);
    }

    function removeTransaction(button) {
        const transactionDiv = button.closest('.transaction-input-group');
        transactionDiv.remove();
    }

    function loadStrategyConditions() {
        const strategyId = document.getElementById('strategySelect').value;
        const conditionsSection = document.getElementById('strategyConditions');
        const conditionsList = document.getElementById('conditionsList');
        const strategy = strategiesData.find(obj => obj.id === parseInt(strategyId));

        if (!strategyId || !strategy) {
            conditionsSection.classList.remove('show');
            return;
        }

        strategyConditions = {};
        
        conditionsList.innerHTML = '';
        
        let maxScore = 0;
        strategy.conditions.forEach(condition => {
            const conditionDiv = document.createElement('div');
            conditionDiv.className = 'condition-item';
            conditionDiv.innerHTML = `
                <div class="form-check">
                    <input class="form-check-input" 
                            type="checkbox" 
                            id="condition_${condition.id}"
                            name="condition_checks"
                            value="${condition.id}"
                            data-value="${condition.score}"
                            onchange="updateScore()">
                    <input type="hidden" id="condition-id-${condition.id}" name="condition_id" value="">
                    <input type="hidden" id="condition-value-${condition.id}" name="condition_value" value="">
                    <label class="form-check-label" for="condition_${condition.id}">
                        <strong>${condition.description}</strong>
                        <small class="text-muted d-block">+${condition.score} points</small>
                    </label>
                </div>
            `;
            conditionsList.appendChild(conditionDiv);
            
            strategyConditions[condition.id] = condition.score;
            maxScore += condition.score;
        });
        
        conditionsSection.classList.add('show');
        updateScore();
        document.getElementById('maxScore').textContent = maxScore;
    }

    function updateScore() {
        const checkedConditions = document.querySelectorAll('input[name="condition_checks"]:checked');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const calculatedScoreEl = document.getElementById('calculatedScore');
        const scoreBreakdownEl = document.getElementById('scoreBreakdown');
        const scoreInput = document.querySelector('input[name="score"]');
        
        let totalScore = 0;
        let breakdown = [];
        
        checkedConditions.forEach(checkbox => {
            let parent = checkbox.parentElement;
            const conditionId = checkbox.value;
            const points = strategyConditions[conditionId] || 0;
            parent.querySelector(`#condition-id-${conditionId}`).value = conditionId; 
            parent.querySelector(`#condition-value-${conditionId}`).value = checkbox.dataset.value;
            totalScore += points;
            
            const label = checkbox.parentNode.querySelector('label strong').textContent;
            breakdown.push(`${label}: +${points}`);
            
            // Agregar clase visual
            checkbox.closest('.condition-item').classList.add('checked');
        });
        
        // Remover clase de condiciones no marcadas
        document.querySelectorAll('input[name="condition_checks"]:not(:checked)').forEach(checkbox => {
            const conditionId = checkbox.value;
            document.getElementById(`condition-id-${conditionId}`).value = ''; 
            document.getElementById(`condition-value-${conditionId}`).value = '';
            checkbox.closest('.condition-item').classList.remove('checked');
        });
        
        // Actualizar display
        calculatedScoreEl.textContent = totalScore;
        scoreBreakdownEl.innerHTML = breakdown.length > 0 ? breakdown.join('<br>') : 'Ninguna condición seleccionada';
        
        // Actualizar input del formulario
        scoreInput.value = totalScore/parseInt(document.getElementById('maxScore').textContent);
        
        // Mostrar/ocultar display de puntuación
        if (checkedConditions.length > 0) {
            scoreDisplay.style.display = 'block';
        } else {
            scoreDisplay.style.display = 'none';
        }
    }

    function updateFilePreview() {
        const fileInputs = document.querySelectorAll('input[type="file"]');
        const filePreview = document.getElementById('file-preview');
        filePreview.innerHTML = '';
        
        fileInputs.forEach(input => {
            if (input.files.length > 0) {
                const fileType = input.name; // 'images' or 'videos'
                const fileTypeLabel = fileType === 'images' ? 'Imágenes' : 'Videos';
                
                const previewSection = document.createElement('div');
                previewSection.className = 'mb-3';
                previewSection.innerHTML = `<strong>${fileTypeLabel} seleccionados:</strong>`;
                
                const fileList = document.createElement('ul');
                fileList.className = 'list-unstyled mt-2';
                
                Array.from(input.files).forEach(file => {
                    const listItem = document.createElement('li');
                    listItem.className = 'text-muted';
                    listItem.innerHTML = `
                        <i class="fas fa-${fileType === 'images' ? 'image' : 'video'} me-2"></i>
                        ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                    `;
                    fileList.appendChild(listItem);
                });
                
                previewSection.appendChild(fileList);
                filePreview.appendChild(previewSection);
            }
        });
    }

    // Validación del formulario
    document.getElementById('tradeForm').addEventListener('submit', function (e) {
        const strategySelect = document.getElementById('strategySelect');

        // Validar que se haya seleccionado una estrategia
        if (!strategySelect.value) {
            e.preventDefault();
            alert('Debe seleccionar una estrategia.');
            strategySelect.focus();
            return false;
        }

        // Validar que se hayan marcado condiciones
        const checkedConditions = document.querySelectorAll('input[name="condition_checks"]:checked');
        if (checkedConditions.length === 0) {
            e.preventDefault();
            alert('Debe marcar al menos una condición de la estrategia para calcular la puntuación.');
            return false;
        }
        // Todo validado correctamente
        return true;
    });


    document.addEventListener('DOMContentLoaded', function() {
        {% if trade %}
            {% for transaction in trade.transactions %}
                addTransaction(
                    date="{{transaction.date}}",
                    time="{{transaction.time}}",
                    price="{{transaction.price}}",
                    quantity="{{transaction.quantity}}",
                    commission="{{transaction.commission}}",
                    type="{{transaction.type}}"
                );
            {% endfor %}
            {% for error in trade.errors %}
                addError(id="{{error.id}}", value="{{error.description}}", category="{{error.category}}", severity="{{error.severity}}");
            {% endfor %}

            loadStrategyConditions();
            {% for condition in trade.conditions %}
                document.getElementById(`condition_{{condition.id}}`).click();
            {% endfor %}
        {% else %}
            addError();
            loadStrategyConditions();
        {% endif %}
    });
</script>

{% endblock %}