{% extends "base.html" %}

{% block style %}
<style>
.profit { color: #28a745 !important; }
.loss { color: #dc3545 !important; }
.card { box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
.nav-tabs .nav-link { border-bottom: 2px solid transparent; }
.nav-tabs .nav-link.active { border-bottom-color: #007bff; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- TODO: Apply filters (almost for everything). Plot trade evolution charts and trader 
     evolution charts (based on errors and trade conditions met) -->
    <!-- Header con filtros -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-bar me-2"></i>Análisis de Rendimiento</h2>
        
        <!-- Filtros de período -->
        <div class="d-flex gap-2">
            <select id="periodFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="all">Todo el tiempo</option>
                <option value="30">Últimos 30 días</option>
                <option value="90">Últimos 90 días</option>
                <option value="365">Último año</option>
            </select>
            <select id="strategyFilter" class="form-select form-select-sm" style="width: auto;">
                <option value="">Todas las estrategias</option>
                {% for strategy in strategies %}
                <option value="{{ strategy.id }}">{{ strategy.name }}</option>
                {% endfor %}
            </select>
        </div>
    </div>

    <!-- KPIs principales -->
    <div class="row mb-4">
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="text-primary mb-2">
                        <i class="fas fa-exchange-alt fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ stats.total_trades }}</h3>
                    <p class="text-muted mb-0 small">Total Trades</p>
                    <small class="text-success">
                        <i class="fas fa-arrow-up"></i> {{ stats.trades_this_month }} este mes
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="text-success mb-2">
                        <i class="fas fa-percentage fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ stats.win_rate }}%</h3>
                    <p class="text-muted mb-0 small">Tasa de Éxito</p>
                    <div class="progress mt-2" style="height: 5px;">
                        <div class="progress-bar bg-success" style="width: {{ stats.win_rate }}%"></div>
                    </div>
                    <small class="text-muted">
                        {{ stats.winning_trades }}W / {{ stats.losing_trades }}L
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="{% if stats.total_pnl > 0 %}text-success{% else %}text-danger{% endif %} mb-2">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                    <h3 class="mb-1 {% if stats.total_pnl > 0 %}text-success{% else %}text-danger{% endif %}">
                        ${{ "%.2f"|format(stats.total_pnl) }}
                    </h3>
                    <p class="text-muted mb-0 small">P&L Total</p>
                    <small class="{% if stats.pnl_change > 0 %}text-success{% else %}text-danger{% endif %}">
                        <i class="fas fa-arrow-{{ 'up' if stats.pnl_change > 0 else 'down' }}"></i> 
                        {{ "%.1f"|format(stats.pnl_change|abs) }}% vs mes anterior
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="text-info mb-2">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ "%.2f"|format(stats.avg_trade) }}</h3>
                    <p class="text-muted mb-0 small">P&L Promedio</p>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="text-warning mb-2">
                        <i class="fas fa-bullseye fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ "%.2f"|format(stats.sharpe_ratio) }}</h3>
                    <p class="text-muted mb-0 small">Ratio Sharpe</p>
                    <small class="{% if stats.sharpe_ratio > 1 %}text-success{% elif stats.sharpe_ratio > 0.5 %}text-warning{% else %}text-danger{% endif %}">
                        {% if stats.sharpe_ratio > 1 %}Excelente
                        {% elif stats.sharpe_ratio > 0.5 %}Bueno
                        {% else %}Mejorable{% endif %}
                    </small>
                </div>
            </div>
        </div>
        
        <div class="col-xl-2 col-md-4 col-sm-6 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <div class="text-danger mb-2">
                        <i class="fas fa-arrow-down fa-2x"></i>
                    </div>
                    <h3 class="mb-1">{{ "%.1f"|format(stats.max_drawdown) }}%</h3>
                    <p class="text-muted mb-0 small">Max Drawdown</p>
                    <small class="{% if stats.max_drawdown < 5 %}text-success{% elif stats.max_drawdown < 15 %}text-warning{% else %}text-danger{% endif %}">
                        {% if stats.max_drawdown < 5 %}Bajo riesgo
                        {% elif stats.max_drawdown < 15 %}Riesgo moderado
                        {% else %}Alto riesgo{% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráficos principales -->
    <div class="row mb-4">
        <!-- Balance histórico -->
        <div class="col-lg-8 mb-4">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-chart-area me-2"></i>Evolución del Balance</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <input type="radio" class="btn-check" name="chartType" id="equity" checked>
                        <label class="btn btn-outline-primary" for="equity">Equity</label>
                        
                        <input type="radio" class="btn-check" name="chartType" id="drawdown">
                        <label class="btn btn-outline-primary" for="drawdown">Drawdown</label>
                        
                        <input type="radio" class="btn-check" name="chartType" id="returns">
                        <label class="btn btn-outline-primary" for="returns">Retornos</label>
                    </div>
                </div>
                <div class="card-body" style="height: 300px;">
                    <canvas id="balanceChart" style="height: 300px;"></canvas>
                </div>
            </div>
        </div>
        
        <!-- Distribución y métricas -->
        <div class="col-lg-4 mb-4">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Distribución P&L</h5>
                </div>
                <div class="card-body">
                    <div style="height: 250px;">
                        <canvas id="pnlDistribution" style="height: 250px;"></canvas>
                    </div>
                    
                    <!-- Métricas de riesgo -->
                    <div class="mt-4">
                        <div class="row text-center">
                            <div class="col-6">
                                <h6 class="text-success">Ganancia Promedio</h6> 
                                <strong class="text-success">${{ "%.2f"|format(stats.avg_win) }}</strong>
                            </div>
                            <div class="col-6">
                                <h6 class="text-danger">Pérdida Promedio</h6>
                                <strong class="text-danger">${{ "%.2f"|format(stats.avg_loss) }}</strong>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <h6>Ratio Ganancia/Pérdida</h6>
                            <h4 class="{% if stats.profit_factor > 1 %}text-success{% else %}text-danger{% endif %}">
                                {{ "%.2f"|format(stats.risk_reward) }} (PF: {{ "%.2f"|format(stats.profit_factor) }})
                            </h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='chatjs-4.5.0-dist/chart.umd.min.js') }}"></script>
<script>
// Configuración de datos para los gráficos
const chartData = {
    balances: {{ stats.balances | tojson }}
};

// Inicializar todos los gráficos
document.addEventListener('DOMContentLoaded', function() {
    initBalanceChart();
    initPnLDistribution();
});

function initBalanceChart() {
    const ctx = document.getElementById('balanceChart');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: chartData.balances.map(b => b.date),
            datasets: [{
                label: 'Balance',
                data: chartData.balances.map(b => b.balance),
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return '$' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}

function initPnLDistribution() {
    const ctx = document.getElementById('pnlDistribution');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Ganadores', 'Perdedores'],
            datasets: [{
                data: [{{ stats.winning_trades }}, {{ stats.losing_trades }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// Filtros dinámicos
document.getElementById('periodFilter').addEventListener('change', function() {
    // Implementar filtrado por período
});

document.getElementById('strategyFilter').addEventListener('change', function() {
    // Implementar filtrado por estrategia
});
</script>
{% endblock %}