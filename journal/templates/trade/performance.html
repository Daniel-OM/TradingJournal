{% extends "base.html" %}


{% block title %}Performance - Trading Journal</title>{% endblock %}

{% block style %}{% endblock %}

{% block content %}
<div class="row">
    <!-- Filters -->
    <div class="col-12 mb-3">
        <div class="card card-body mb-2">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Start Date</label>
                    <input type="date" id="start-date" class="rounded">
                </div>
                <div class="filter-group">
                    <label>End Date</label>
                    <input type="date" id="end-date" class="rounded">
                </div>
                <div class="filter-group">
                    <label>Strategy</label>
                    <select id="strategy" class="rounded">
                        <option value="">All Strategies</option>
                        {% for strat in strategies %}
                            <option value="{{ strat.id }}" {% if strat.id == strategy_id %}selected{% endif %}>{{ strat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Symbol</label>
                    <input type="text" id="symbol" placeholder="e.g., AAPL" class="rounded">
                </div>
                <div class="filter-group">
                    <label>Side</label>
                    <select id="side" class="rounded">
                        <option value="BOTH">Both</option>
                        <option value="LONG">Long</option>
                        <option value="SHORT">Short</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Limit</label>
                    <input id="limit" type="number" min="0" step="1" placeholder="e.g., 100" class="rounded">
                </div>
            </div>
            <div class="filter-actions align-items-center">
                <button class="btn btn-pill bg-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-pill bg-secondary" onclick="resetFilters()">Reset</button>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" role="switch" onchange="changeGrossNet()" id="gross-switch">
                    <label class="form-check-label" for="flexSwitchCheckDefault">Gross</label>
                </div>
            </div>
        </div>
    </div>

    <div class="col col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card card-body">
            <div class="summary-value" id="total-pnl">$0</div>
            <div class="summary-label">Total P&L </div>
        </div>
    </div>
    <div class="col col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card card-body">
            <div class="summary-value" id="win-rate">0%</div>
            <div class="summary-label">Win Rate</div>
        </div>
    </div>
    <div class="col col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card card-body">
            <div class="summary-value" id="risk-reward">0</div>
            <div class="summary-label">Risk/Reward</div>
        </div>
    </div>
    <div class="col col-lg-3 col-md-4 col-sm-6 mb-3">
        <div class="card card-body">
            <div class="summary-value" id="total-trades">0</div>
            <div class="summary-label">Total Trades</div>
        </div>
    </div>
    
    <div class="col-12 mb-3">
        <div class="card">
            <div class="card-body row m-0">
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>Trading Overview</h3>
                    <div class="stat-row">
                        <span class="stat-label">Total P&L</span>
                        <span class="stat-value" id="total-pnl-stat">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Win Rate</span>
                        <span class="stat-value" id="win-rate-stat">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Trades</span>
                        <span class="stat-value" id="total-trades-stat">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Winning Trades</span>
                        <span class="stat-value" id="winning-trades">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Losing Trades</span>
                        <span class="stat-value" id="losing-trades">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Scratch Trades</span>
                        <span class="stat-value" id="scratch-trades">0</span>
                    </div>
                </div>
        
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>Average Performance</h3>
                    <div class="stat-row">
                        <span class="stat-label">Average Trade P&L</span>
                        <span class="stat-value" id="avg-trade">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Win</span>
                        <span class="stat-value" id="avg-win">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Loss</span>
                        <span class="stat-value negative" id="avg-loss">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Daily P&L</span>
                        <span class="stat-value" id="avg-daily">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average P&L per Share</span>
                        <span class="stat-value" id="avg-share">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Daily Volume</span>
                        <span class="stat-value" id="avg-volume">$0</span>
                    </div>
                </div>
        
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>Best & Worst</h3>
                    <div class="stat-row">
                        <span class="stat-label">Largest Gain</span>
                        <span class="stat-value" id="largest-gain">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Largest Loss</span>
                        <span class="stat-value" id="largest-loss">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Median Trade P&L</span>
                        <span class="stat-value" id="median">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Max Consecutive Wins</span>
                        <span class="stat-value" id="max-wins">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Max Consecutive Losses</span>
                        <span class="stat-value" id="max-losses">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Current Streak</span>
                        <span class="stat-value" id="current-streak">0</span>
                    </div>
                </div>
        
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>P&L Distribution</h3>
                    <div class="stat-row">
                        <span class="stat-label">Winning P&L</span>
                        <span class="stat-value" id="winning-pnl">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Losing P&L</span>
                        <span class="stat-value" id="losing-pnl">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Trade P&L Std Dev</span>
                        <span class="stat-value" id="std">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Risk/Reward Ratio</span>
                        <span class="stat-value" id="risk-reward-stat">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Profit Factor</span>
                        <span class="stat-value" id="profit-factor">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Recovery Rate</span>
                        <span class="stat-value" id="recovery-rate">0%</span>
                    </div>
                </div>
        
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>Risk Analysis</h3>
                    <div class="stat-row">
                        <span class="stat-label">Max Drawdown</span>
                        <span class="stat-value" id="drawdown">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Sharpe Ratio</span>
                        <span class="stat-value" id="sharpe">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">SQN Score</span>
                        <span class="stat-value" id="sqn">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">K-Ratio</span>
                        <span class="stat-value" id="k-ratio">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Kelly %</span>
                        <span class="stat-value" id="kelly">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">P-Value</span>
                        <span class="stat-value" id="p-value">0</span>
                    </div>
                </div>
        
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>Hold Time Analysis</h3>
                    <div class="stat-row">
                        <span class="stat-label">Average Hold Time (Overall)</span>
                        <span class="stat-value" id="hold-overall">0m</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Hold Time (Winners)</span>
                        <span class="stat-value" id="hold-winners">0m</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Hold Time (Losers)</span>
                        <span class="stat-value" id="hold-losers">0m</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average Hold Time (Scratches)</span>
                        <span class="stat-value" id="hold-scratches">0m</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Hold Time Pattern</span>
                        <span class="stat-value" id="hold-pattern">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Streak Consistency</span>
                        <span class="stat-value" id="streak-consistency">0</span>
                    </div>
                </div>
        
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>Trading Costs</h3>
                    <div class="stat-row">
                        <span class="stat-label">Total Commissions</span>
                        <span class="stat-value" id="total-commissions">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Fees</span>
                        <span class="stat-value" id="total-fees">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Total Trading Costs</span>
                        <span class="stat-value" id="total-costs">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Cost per Trade</span>
                        <span class="stat-value" id="cost-per-trade">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Cost Impact</span>
                        <span class="stat-value" id="cost-impact">0%</span>
                    </div>
                </div>
        
                <div class="col col-lg-4 col-md-6 mt-3">
                    <h3>Execution Quality</h3>
                    <div class="stat-row">
                        <span class="stat-label">Average MFE (Max Favorable)</span>
                        <span class="stat-value" id="avg-mfe">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average MAE (Max Adverse)</span>
                        <span class="stat-value negative" id="avg-mae">$0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">MFE/MAE Ratio</span>
                        <span class="stat-value" id="mfe-mae-ratio">0</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Efficiency Score</span>
                        <span class="stat-value" id="efficiency">0%</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Exit Quality</span>
                        <span class="stat-value" id="exit-quality">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Equity Curve -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="d-block card-header">
                <i class="fas fa-chart-area me-2"></i>Equity Curve
            </div>
            <div class="card-body">
                <div class="chart-container mt-0">
                    <canvas id="equityChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- P&L Distribution -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="d-block card-header">
                <i class="fas fa-chart-bar me-2"></i>P&L Distribution
            </div>
            <div class="card-body">
                <div class="chart-container mt-0 small">
                    <canvas id="pnlDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Time Analysis Tabs -->
    <div class="col-12 mb-4">
        <div class="card">
            <ul class="nav nav-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#dailyTab" role="tab">
                        <i class="fas fa-calendar-day me-2"></i>Daily
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#monthlyTab" role="tab">
                        <i class="fas fa-calendar-alt me-2"></i>Monthly
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#weekdayTab" role="tab">
                        <i class="fas fa-calendar-week me-2"></i>By Weekday
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#hourlyTab" role="tab">
                        <i class="fas fa-clock me-2"></i>By Hour
                    </a>
                </li>
            </ul>
            <div class="tab-content tv-tab-content">
                <div class="tab-pane fade" id="dailyTab" role="tabpanel">
                    <div class="chart-container mt-0">
                        <canvas id="dailyPnlChart"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade" id="monthlyTab" role="tabpanel">
                    <div class="chart-container mt-0">
                        <canvas id="monthlyPnlChart"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade" id="weekdayTab" role="tabpanel">
                    <div class="chart-container mt-0">
                        <canvas id="weekdayChart"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade show active" id="hourlyTab" role="tabpanel">
                    <div class="chart-container mt-0">
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Symbol Performance -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="d-block card-header">
                <i class="fas fa-chart-pie me-2"></i>Top Symbols Performance
            </div>
            <div class="card-body">
                <div class="chart-container mt-0 small">
                    <canvas id="symbolChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Hold Time Analysis -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="d-block card-header">
                <i class="fas fa-stopwatch me-2"></i>Hold Time vs P&L
            </div>
            <div class="card-body">
                <div class="chart-container mt-0 small">
                    <canvas id="holdTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Size Analysis -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="d-block card-header">
                <i class="fas fa-weight me-2"></i>Position Size Analysis
            </div>
            <div class="card-body">
                <div class="chart-container mt-0">
                    <canvas id="sizeAnalysisChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading charts...</p>
    </div>
</div>
{% endblock %}
{% block scripts %}
    <script>
        
        // Sample data structure that matches the backend stats
        const statsData = JSON.parse('{{ stats|tojson|safe }}');


        // Tab functionality

        // Filter functions
        function applyFilters () {
            const filters = {
                start: document.getElementById('start-date').value,
                end: document.getElementById('end-date').value,
                strategy: document.getElementById('strategy').value,
                symbol: document.getElementById('symbol').value,
                side: document.getElementById('side').value,
                limit: document.getElementById('limit').value
            };

            // En una aplicación real, esto haría una petición al servidor
            window.location.href = `{{ url_for('journal_endpoints.performance') }}?start=${filters.start}&end=${filters.end}&strategy=${filters.strategy}&symbol=${filters.symbol}&side=${filters.side}&limit=${filters.limit}`;
        }

        async function resetFilters () {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('strategy').value = '';
            document.getElementById('symbol').value = '';
            document.getElementById('side').value = '';
            document.getElementById('limit').value = '';

            applyFilters();
        }
        // Simulate real data population
        async function populateStatsFromBackend (stats, mode='net') {
            document.getElementById('total-pnl').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.total_pnl : stats.gross?.total_pnl, 'currency', 1, 2, 'compact')}`;
            document.getElementById('total-pnl').className = 'summary-value ' + (stats.net?.total_pnl > 0 ? 'text-profit' : 'text-loss');
            document.getElementById('win-rate').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.win_rate : stats.gross?.win_rate, 'percentage', 1, 2, 'compact')}`;
            document.getElementById('total-trades').textContent = stats.total_trades;
            document.getElementById('risk-reward').innerHTML = `${mode == 'net' ? stats.net?.risk_reward.toFixed(2) : stats.gross?.risk_reward.toFixed(2)}`;
            document.getElementById('risk-reward').className = 'summary-value ' + (stats.net?.risk_reward > 1 ? 'text-profit' : 'text-loss');

            
            document.getElementById('total-pnl-stat').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.total_pnl : stats.gross?.total_pnl, 'currency', 1, 2, 'compact')}`;
            document.getElementById('win-rate-stat').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.win_rate : stats.gross?.win_rate, 'percentage', 1, 2, 'compact')}`;
            document.getElementById('total-trades-stat').textContent = stats.total_trades;

            document.getElementById('winning-trades').innerHTML = `${mode == 'net' ? stats.net?.winning_trades : stats.gross?.winning_trades}`;
            document.getElementById('losing-trades').innerHTML = `${mode == 'net' ? stats.net?.losing_trades : stats.gross?.losing_trades}`;
            document.getElementById('scratch-trades').innerHTML = `${mode == 'net' ? stats.net?.scratch_trades : stats.gross?.scratch_trades}`;

            document.getElementById('avg-trade').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.avg_trade_pnl : stats.gross?.avg_trade_pnl, 'currency', 1, 2, 'compact')}`;
            document.getElementById('avg-share').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.avg_pnl_per_share : stats.gross?.avg_pnl_per_share, 'currency', 1, 2, 'compact')}`;
            document.getElementById('median').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.median_trade_pnl : stats.gross?.median_trade_pnl, 'currency', 1, 2, 'compact')}`;
            document.getElementById('largest-gain').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.largest_gain : stats.gross?.largest_gain, 'currency', 1, 2, 'compact')}`;
            document.getElementById('largest-loss').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.largest_loss : stats.gross?.largest_loss, 'currency', 1, 2, 'compact')}`;

            document.getElementById('winning-pnl').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.winning_pnl : stats.gross?.winning_pnl, 'currency', 1, 2, 'compact')}`;
            document.getElementById('losing-pnl').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.losing_pnl : stats.gross?.losing_pnl, 'currency', 1, 2, 'compact')}`;
            document.getElementById('avg-win').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.avg_win : stats.gross?.avg_win, 'currency', 1, 2, 'compact')}`;
            document.getElementById('avg-loss').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.avg_loss : stats.gross?.avg_loss, 'currency', 1, 2, 'compact')}`;

            document.getElementById('risk-reward-stat').innerHTML = `${mode == 'net' ? stats.net?.risk_reward.toFixed(2) : stats.gross?.risk_reward.toFixed(2)}`;
            document.getElementById('profit-factor').innerHTML = `${mode == 'net' ? stats.net?.profit_factor.toFixed(2) : stats.gross?.profit_factor.toFixed(2)}`;
            document.getElementById('sharpe').innerHTML = `${mode == 'net' ? stats.net?.sharpe_ratio.toFixed(2) : stats.gross?.sharpe_ratio.toFixed(2)}`;
            document.getElementById('drawdown').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.max_drawdown : stats.gross?.max_drawdown, 'percentage', 1, 2, 'compact')}`;
            document.getElementById('std').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.trade_pnl_std : stats.gross?.trade_pnl_std, 'currency', 1, 2, 'compact')}`;
            document.getElementById('sqn').innerHTML = `${mode == 'net' ? stats.net?.sqn.toFixed(2) : stats.gross?.sqn.toFixed(2)}`;

            document.getElementById('k-ratio').innerHTML = `${mode == 'net' ? stats.net?.k_ratio.toFixed(2) : stats.gross?.k_ratio.toFixed(2)}`;
            document.getElementById('kelly').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.kelly_percent : stats.gross?.kelly_percent, 'percentage', 1, 2, 'compact')}`;
            document.getElementById('p-value').innerHTML = `${mode == 'net' ? stats.net?.p_value.toFixed(4) : stats.gross?.p_value.toFixed(4)}`;
            document.getElementById('avg-daily').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.avg_daily_pnl : stats.gross?.avg_daily_pnl, 'currency', 1, 2, 'compact')}`;
            document.getElementById('avg-volume').innerHTML = `${formatNumber(mode == 'net' ? stats.net?.avg_daily_volume : stats.gross?.avg_daily_volume, 'currency', 1, 2, 'compact')}`;

            document.getElementById('max-wins').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_wins : stats.gross?.max_consecutive_wins}`;
            document.getElementById('max-losses').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_losses : stats.gross?.max_consecutive_losses}`;

            // General Stats Tab
            document.getElementById('total-commissions').textContent = formatNumber(stats.total_commissions, 'currency', 1, 2, 'compact');
            document.getElementById('total-fees').textContent = formatNumber(stats.total_fees, 'currency', 1, 2, 'compact');
            document.getElementById('total-costs').textContent = formatNumber(stats.total_commissions + stats.total_fees, 'currency', 1, 2, 'compact');
            document.getElementById('cost-per-trade').textContent = formatNumber((stats.total_commissions + stats.total_fees) / stats.total_trades, 'currency', 1, 2, 'compact');

            const costImpact = ((stats.gross?.total_pnl - stats.net?.total_pnl) / stats.gross?.total_pnl) * 100;
            document.getElementById('cost-impact').textContent = formatNumber(costImpact, 'percentage', 1, 2, 'compact');

            document.getElementById('hold-overall').textContent = stats.avg_hold_time_overall;
            document.getElementById('hold-winners').textContent = stats.avg_hold_time_winners;
            document.getElementById('hold-losers').textContent = stats.avg_hold_time_losers;
            document.getElementById('hold-scratches').textContent = stats.avg_hold_time_scratches;

            document.getElementById('avg-mfe').textContent = formatNumber(stats.avg_mfe, 'currency', 1, 2, 'compact');
            document.getElementById('avg-mae').textContent = formatNumber(stats.avg_mae, 'currency', 1, 2, 'compact');

            const mfeMaeRatio = Math.abs(stats.avg_mfe / stats.avg_mae);
            document.getElementById('mfe-mae-ratio').textContent = mfeMaeRatio.toFixed(2);

            document.getElementById('max-wins').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_wins : stats.gross?.max_consecutive_wins}`;
            document.getElementById('max-losses').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_losses : stats.gross?.max_consecutive_losses}`;

            // Apply color classes based on values
            applyColorClasses();
        }

        async function applyColorClasses () {
            // Apply positive/negative classes to values
            const elements = document.querySelectorAll('.stat-value');
            elements.forEach(el => {
                const text = el.textContent;
                if (text.includes('-') && !text.includes('ratio') && !text.includes('Ratio')) {
                    if (!el.classList.contains('text-loss')) {
                        el.classList.add('text-loss');
                    }
                } else if (text.includes('%') || text.includes('$')) {
                    const numValue = parseFloat(text.replace(/[^0-9.-]/g, ''));
                    if (numValue > 0) {
                        if (!el.classList.contains('text-profit')) {
                            el.classList.add('text-profit');
                        }
                    } else if (numValue < 0) {
                        if (!el.classList.contains('text-loss')) {
                            el.classList.add('text-loss');
                        }
                    }
                }
            });
        }

        async function changeGrossNet() {
            console.log('Gross/Net toggle changed');
            if (document.getElementById('gross-switch').checked) {
                // Switch to gross mode
                populateStatsFromBackend(statsData, 'gross');
                initializeCharts('gross');
            } else {
                // Switch to net mode
                populateStatsFromBackend(statsData, 'net');
                initializeCharts('net');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Set default date range (last 30 days)
            const endDate = new Date("{{ end }}");
            const startDate = new Date("{{ start}}");

            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
            document.querySelector(`option[value="${ "{{ side or 'BOTH' }}" }"]`).selected = true;
            document.getElementById('symbol').value = "{{ asset_symbol if asset_symbol != 'None' else '' }}" || '';
            document.getElementById('limit').value = "{{ limit }}" || '';

            // Load initial data with sample stats
            populateStatsFromBackend(statsData);

            // Add keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    applyFilters();
                }
            });
        });
        



        const chartsData = JSON.parse('{{ charts|tojson|safe }}');

        // Chart instances
        let charts = {};
        
        // Chart.js default config
        Chart.defaults.color = '#b0b0b0';
        Chart.defaults.backgroundColor = '#2d2d2d';
        Chart.defaults.borderColor = '#404040';

        // Global chart options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            /* plugins: {
                legend: {
                    labels: {
                        color: '#b0b0b0',
                        font: {
                            size: 12
                        }
                    }
                }
            }, */
            scales: {
                x: {
                    ticks: { color: '#b0b0b0' },
                    grid: { color: '#b0b0b0' }
                },
                y: {
                    ticks: { color: '#b0b0b0' },
                    grid: { color: '#b0b0b0' }
                }
            }
        };


        async function initializeCharts(mode='net') {

            const data = mode == 'gross' ? chartsData.gross : chartsData.net;

            showLoading(true);

            // Equity Curve
            if (charts.equity) {
                charts.equity.destroy();
            }
            const equityCtx = document.getElementById('equityChart').getContext('2d');
            charts.equity = new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: data.equity_curve?.dates,
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: data.equity_curve?.equity,
                        borderColor: '#007cff',
                        backgroundColor: 'rgba(0, 124, 255, 0.1)',
                        fill: true,
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'DrawDown',
                        data: data.equity_curve?.drawdown,
                        borderColor: '#ff322d',
                        backgroundColor: 'rgba(255, 50, 45, 0.1)',
                        fill: true,
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#b0b0b0' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `P&L: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });

            // P&L Distribution
            if (charts.pnlDist) {
                charts.pnlDist.destroy();
            }
            const pnlDistCtx = document.getElementById('pnlDistributionChart').getContext('2d');
            charts.pnlDist = new Chart(pnlDistCtx, {
                type: 'bar',
                data: {
                    labels: data.pnl_distribution?.bins,
                    datasets: [{
                        label: 'Trades',
                        data: data.pnl_distribution?.counts,
                        backgroundColor: function(context) {
                            const value = context.parsed?.x;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Daily P&L
            if (charts.daily) {
                charts.daily.destroy();
            }
            const dailyCtx = document.getElementById('dailyPnlChart').getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: data.daily_pnl?.dates,
                    datasets: [{
                        label: 'Daily P&L',
                        data: data.daily_pnl?.pnl,
                        backgroundColor: function(context) {
                            const value = context.parsed?.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Monthly P&L
            if (charts.monthly) {
                charts.monthly.destroy();
            }
            const monthlyCtx = document.getElementById('monthlyPnlChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: data.monthly_pnl?.months,
                    datasets: [{
                        label: 'Monthly P&L',
                        data: data.monthly_pnl?.pnl,
                        backgroundColor: function(context) {
                            const value = context.parsed?.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Weekday Analysis
            if (charts.weekday) {
                charts.weekday.destroy();
            }
            const weekdayCtx = document.getElementById('weekdayChart').getContext('2d');
            charts.weekday = new Chart(weekdayCtx, {
                type: 'bar',
                data: {
                    labels: data.weekday_analysis?.days,
                    datasets: [{
                        label: 'Expectancy',
                        data: data.weekday_analysis?.expectancy,
                        backgroundColor: function(context) {
                            const value = context.parsed?.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Hourly Analysis
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
            charts.hourly = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: data.hour_analysis?.hours.map(h => new Date(`1970-01-01 ${h}:00+00:00`).toLocaleString([], { hour: '2-digit', minute: '2-digit' })),
                    datasets: [{
                        label: 'Expectancy',
                        data: data.hour_analysis?.expectancy,
                        backgroundColor: function(context) {
                            const value = context.parsed?.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Symbol Performance
            if (charts.symbol) {
                charts.symbol.destroy();
            }
            const symbolCtx = document.getElementById('symbolChart').getContext('2d');
            charts.symbol = new Chart(symbolCtx, {
                type: 'doughnut',
                data: {
                    labels: data.symbol_performance?.symbols,
                    datasets: [{
                        data: data.symbol_performance?.expectancy,
                        backgroundColor: [
                            '#007cff', '#00c851', '#ff4444', '#ffbb33', '#9c27b0',
                            '#e91e63', '#795548', '#607d8b', '#ff9800', '#4caf50'
                        ]
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {} // Remove scales for doughnut chart
                }
            });

            // Hold Time Analysis
            if (charts.holdTime) {
                charts.holdTime.destroy();
            }
            const holdTimeCtx = document.getElementById('holdTimeChart').getContext('2d');
            charts.holdTime = new Chart(holdTimeCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Trades', // TODO: Scatter without string x axis
                        data: data.hold_time_analysis?.hold_times.map((x, i) => ({ x: Math.round(x).toFixed(0) , y: data.hold_time_analysis?.pnl[i] })).sort((a, b) => Number(a.x) - Number(b.x)),
                        backgroundColor: function(context) {
                            const dataPoint = context.raw;
                            return dataPoint ? dataPoint.y > 0 ? '#00c851' : dataPoint.y < 0 ? '#ff4444' : '#b0b0b0' : '#b0b0b0';
                        }
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        x: {
                            ...commonOptions.scales.x,
                            title: {
                                display: true,
                                text: 'Hold Time (hours)',
                                color: '#b0b0b0'
                            }
                        },
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: 'P&L ($)',
                                color: '#b0b0b0'
                            }
                        }
                    }
                }
            });

            // Size Analysis
            if (charts.size) {
                charts.size.destroy();
            }
            const sizeCtx = document.getElementById('sizeAnalysisChart').getContext('2d');
            charts.size = new Chart(sizeCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Trades', // TODO: Scatter without string x axis
                        data: data.size_analysis?.sizes.map((x, i) => ({ x: Math.round(x).toFixed(0) , y: data.size_analysis?.pnl[i] })).sort((a, b) => Number(a.x) - Number(b.x)),
                        backgroundColor: function(context) {
                            const dataPoint = context.raw;
                            return dataPoint ? dataPoint.y > 0 ? '#00c851' : dataPoint.y < 0 ? '#ff4444' : '#b0b0b0' : '#b0b0b0';
                        }
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        x: {
                            ...commonOptions.scales.x,
                            title: {
                                display: true,
                                text: 'Position Size',
                                color: '#b0b0b0'
                            }
                        },
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: 'P&L ($)',
                                color: '#b0b0b0'
                            }
                        }
                    }
                }
            });
        
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts('net');
        });

    </script>
{% endblock %}