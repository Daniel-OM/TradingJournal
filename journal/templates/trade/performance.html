{% extends "base.html" %}


{% block title %}Performance - Trading Journal</title>{% endblock %}

{% block style %}
<style>
    :root {
        --tv-dark-bg: #0d1421;
        --tv-card-bg: #131722;
        --tv-text-primary: #ffffff;
        --tv-text-secondary: #b0b0b0;
        --tv-green: #00c851;
        --tv-red: #ff4444;
        --tv-blue: #007cff;
        --tv-yellow: #ffbb33;
        --tv-border: #404040;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--tv-dark-bg);
        color: var(--tv-text-primary); /* #d1d4dc; */
        line-height: 1.5;
    }

    .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .header {
        margin-bottom: 30px;
    }

    .header h1 {
        font-size: 28px;
        font-weight: 600;
        color: #ffffff;
        margin-bottom: 8px;
    }

    .header .subtitle {
        color: #868b94;
        font-size: 14px;
    }

    /* Filters */
    .filters {
        background: #131722;
        border: 1px solid #2a2e39;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 30px;
    }

    .filters h3 {
        color: #ffffff;
        margin-bottom: 15px;
        font-size: 16px;
        font-weight: 600;
    }

    .filter-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
    }

    .filter-group label {
        color: #868b94;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filter-group select,
    .filter-group input {
        background: #1e222d;
        border: 1px solid #2a2e39;
        border-radius: 4px;
        color: #d1d4dc;
        padding: 8px 12px;
        font-size: 14px;
        transition: all 0.2s;
    }

    .filter-group select:focus,
    .filter-group input:focus {
        outline: none;
        border-color: #2962ff;
        box-shadow: 0 0 0 2px rgba(41, 98, 255, 0.1);
    }

    .filter-actions {
        grid-column: 1 / -1;
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }

    .btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary {
        background: #2962ff;
        color: white;
    }

    .btn-primary:hover {
        background: #1e53e5;
    }

    .btn-secondary {
        background: #2a2e39;
        color: #d1d4dc;
        border: 1px solid #434651;
    }

    .btn-secondary:hover {
        background: #363a45;
    }

    /* Tab Navigation */
    .tab-nav {
        display: flex;
        gap: 2px;
        margin-bottom: 30px;
        border-bottom: 1px solid #2a2e39;
    }

    .tab-btn {
        background: transparent;
        border: none;
        padding: 12px 20px;
        color: #868b94;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn.active {
        color: #2962ff;
        border-bottom-color: #2962ff;
    }

    .tab-btn:hover {
        color: #d1d4dc;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stats-card {
        background: #131722;
        border: 1px solid #2a2e39;
        border-radius: 8px;
        padding: 20px;
    }

    .stats-card h3 {
        color: #ffffff;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stats-card h3::before {
        content: '';
        width: 3px;
        height: 16px;
        background: #2962ff;
        border-radius: 2px;
    }

    .stat-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #1e222d;
    }

    .stat-row:last-child {
        border-bottom: none;
    }

    .stat-label {
        color: #868b94;
        font-size: 13px;
        font-weight: 500;
    }

    .stat-value {
        font-size: 14px;
        font-weight: 600;
        color: #d1d4dc;
    }

    .stat-value.positive {
        color: #00c851;
    }

    .stat-value.negative {
        color: #ff4444;
    }

    .stat-value.neutral {
        color: #ffbb33;
    }

    .gross-value {
        font-size: 0.7em;
    }

    /* Summary Cards */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
    }

    .summary-card {
        background: #131722;
        border: 1px solid #2a2e39;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }

    .summary-card .value {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 5px;
    }

    .summary-card .label {
        color: #868b94;
        font-size: 12px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Tab Content */

    .tv-card {
        background-color: var(--tv-card-bg);
        border: 1px solid var(--tv-border);
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    .tv-card-header {
        background-color: transparent;
        border-bottom: 1px solid var(--tv-border);
        padding: 16px 20px;
        font-weight: 600;
        font-size: 16px;
    }

    .tv-card-body {
        padding: 20px;
    }

    .tv-metric {
        text-align: center;
        padding: 10px;
    }

    .tv-metric-value {
        font-size: 24px;
        font-weight: bold;
        margin-bottom: 4px;
    }

    .tv-metric-label {
        font-size: 12px;
        color: var(--tv-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tv-positive {
        color: var(--tv-green);
    }

    .tv-negative {
        color: var(--tv-red);
    }

    .tv-neutral {
        color: var(--tv-text-secondary);
    }

    .tv-tab-content {
        background-color: var(--tv-card-bg);
        border: 1px solid var(--tv-border);
        border-top: none;
        border-radius: 0 0 8px 8px;
        padding: 20px;
    }

    .nav-tabs {
        background-color: var(--tv-card-bg);
        border-bottom: 1px solid var(--tv-border);
        border-radius: 8px 8px 0 0;
    }

    .nav-tabs .nav-link {
        color: var(--tv-text-secondary);
        background-color: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        border-radius: 0;
        padding: 12px 20px;
        font-weight: 500;
    }

    .nav-tabs .nav-link:hover {
        color: var(--tv-text-primary);
        border-color: transparent;
        background-color: rgba(255,255,255,0.05);
    }

    .nav-tabs .nav-link.active {
        color: var(--tv-blue);
        background-color: transparent;
        border-bottom-color: var(--tv-blue);
    }

    .chart-container {
        position: relative;
        height: 400px;
        margin-top: 20px;
    }

    .chart-container.small {
        height: 300px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .btn-tv {
        background-color: var(--tv-blue);
        border-color: var(--tv-blue);
        color: white;
        border-radius: 6px;
        font-weight: 500;
    }

    .btn-tv:hover {
        background-color: #0056cc;
        border-color: #0056cc;
        color: white;
    }

    .loading-spinner {
        display: none;
        text-align: center;
        padding: 40px;
    }

    .table-dark {
        background-color: var(--tv-card-bg);
        color: var(--tv-text-primary);
    }

    .table-dark td, .table-dark th {
        border-color: var(--tv-border);
    }

    .performance-summary {
        background: linear-gradient(135deg, var(--tv-card-bg) 0%, rgba(0,124,255,0.1) 100%);
    }

    /* Responsive */
    @media (max-width: 768px) {
        .container {
            padding: 15px;
        }

        .filter-row {
            grid-template-columns: 1fr;
        }

        .stats-grid {
            grid-template-columns: 1fr;
        }

        .summary-cards {
            grid-template-columns: repeat(2, 1fr);
        }

        .tab-nav {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Performance Analysis</h1>
            <p class="subtitle">Comprehensive trading performance metrics and analysis</p>
        </div>

        <!-- Filters -->
        <div class="filters">
            <div class="filter-row">
                <div class="filter-group">
                    <label>Start Date</label>
                    <input type="date" id="start-date">
                </div>
                <div class="filter-group">
                    <label>End Date</label>
                    <input type="date" id="end-date">
                </div>
                <div class="filter-group">
                    <label>Strategy</label>
                    <select id="strategy">
                        <option value="">All Strategies</option>
                        {% for strat in strategies %}
                            <option value="{{ strat.id }}" {% if strat.id == strategy_id %}selected{% endif %}>{{ strat.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="filter-group">
                    <label>Symbol</label>
                    <input type="text" id="symbol" placeholder="e.g., AAPL">
                </div>
                <div class="filter-group">
                    <label>Side</label>
                    <select id="side">
                        <option value="BOTH">Both</option>
                        <option value="LONG">Long</option>
                        <option value="SHORT">Short</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Limit</label>
                    <input id="limit" type="number" min="0" step="1" placeholder="e.g., 100">
                </div>
            </div>
            <div class="filter-actions align-items-center">
                <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
                <button class="btn btn-secondary" onclick="resetFilters()">Reset</button>
                <div class="form-check form-switch ms-auto">
                    <input class="form-check-input" type="checkbox" role="switch" onchange="changeGrossNet()" id="gross-switch">
                    <label class="form-check-label" for="flexSwitchCheckDefault">Gross</label>
                </div>
            </div>
        </div>

        <div class="summary-cards">
            <div class="summary-card">
                <div class="value positive" id="total-pnl">$0</div>
                <div class="label">Total P&L </div>
            </div>
            <div class="summary-card">
                <div class="value positive" id="win-rate">0%</div>
                <div class="label">Win Rate</div>
            </div>
            <div class="summary-card">
                <div class="value positive" id="risk-reward">0</div>
                <div class="label">Risk/Reward</div>
            </div>
            <div class="summary-card">
                <div class="value" id="total-trades">0</div>
                <div class="label">Total Trades</div>
            </div>
        </div>

        <div class="row g-3 stats-card">
            <div class="col col-lg-4 col-md-6">
                <h3>Trading Overview</h3>
                <div class="stat-row">
                    <span class="stat-label">Total P&L</span>
                    <span class="stat-value positive" id="total-pnl-stat">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Win Rate</span>
                    <span class="stat-value positive" id="win-rate-stat">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Trades</span>
                    <span class="stat-value neutral" id="total-trades-stat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Winning Trades</span>
                    <span class="stat-value positive" id="winning-trades">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Losing Trades</span>
                    <span class="stat-value negative" id="losing-trades">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Scratch Trades</span>
                    <span class="stat-value neutral" id="scratch-trades">0</span>
                </div>
            </div>

            <div class="col col-lg-4 col-md-6">
                <h3>Average Performance</h3>
                <div class="stat-row">
                    <span class="stat-label">Average Trade P&L</span>
                    <span class="stat-value positive" id="avg-trade">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Win</span>
                    <span class="stat-value positive" id="avg-win">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Loss</span>
                    <span class="stat-value negative" id="avg-loss">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Daily P&L</span>
                    <span class="stat-value positive" id="avg-daily">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average P&L per Share</span>
                    <span class="stat-value positive" id="avg-share">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Daily Volume</span>
                    <span class="stat-value" id="avg-volume">$0</span>
                </div>
            </div>

            <div class="col col-lg-4 col-md-6">
                <h3>Best & Worst</h3>
                <div class="stat-row">
                    <span class="stat-label">Largest Gain</span>
                    <span class="stat-value positive" id="largest-gain">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Largest Loss</span>
                    <span class="stat-value negative" id="largest-loss">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Median Trade P&L</span>
                    <span class="stat-value positive" id="median">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Max Consecutive Wins</span>
                    <span class="stat-value positive" id="max-wins">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Max Consecutive Losses</span>
                    <span class="stat-value negative" id="max-losses">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Current Streak</span>
                    <span class="stat-value positive" id="current-streak">0</span>
                </div>
            </div>

            <div class="col col-lg-4 col-md-6">
                <h3>P&L Distribution</h3>
                <div class="stat-row">
                    <span class="stat-label">Winning P&L</span>
                    <span class="stat-value positive" id="winning-pnl">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Losing P&L</span>
                    <span class="stat-value negative" id="losing-pnl">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Trade P&L Std Dev</span>
                    <span class="stat-value" id="std">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Risk/Reward Ratio</span>
                    <span class="stat-value" id="risk-reward-stat">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Profit Factor</span>
                    <span class="stat-value positive" id="profit-factor">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Recovery Rate</span>
                    <span class="stat-value positive" id="recovery-rate">0%</span>
                </div>
            </div>

            <div class="col col-lg-4 col-md-6">
                <h3>Risk Analysis</h3>
                <div class="stat-row">
                    <span class="stat-label">Max Drawdown</span>
                    <span class="stat-value negative" id="drawdown">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Sharpe Ratio</span>
                    <span class="stat-value positive" id="sharpe">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">SQN Score</span>
                    <span class="stat-value positive" id="sqn">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">K-Ratio</span>
                    <span class="stat-value positive" id="k-ratio">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Kelly %</span>
                    <span class="stat-value" id="kelly">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">P-Value</span>
                    <span class="stat-value" id="p-value">0</span>
                </div>
            </div>

            <div class="col col-lg-4 col-md-6">
                <h3>Hold Time Analysis</h3>
                <div class="stat-row">
                    <span class="stat-label">Average Hold Time (Overall)</span>
                    <span class="stat-value" id="hold-overall">0m</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Hold Time (Winners)</span>
                    <span class="stat-value positive" id="hold-winners">0m</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Hold Time (Losers)</span>
                    <span class="stat-value negative" id="hold-losers">0m</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average Hold Time (Scratches)</span>
                    <span class="stat-value neutral" id="hold-scratches">0m</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Hold Time Pattern</span>
                    <span class="stat-value positive" id="hold-pattern">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Streak Consistency</span>
                    <span class="stat-value positive" id="streak-consistency">0</span>
                </div>
            </div>

            <div class="col col-lg-4 col-md-6">
                <h3>Trading Costs</h3>
                <div class="stat-row">
                    <span class="stat-label">Total Commissions</span>
                    <span class="stat-value negative" id="total-commissions">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Fees</span>
                    <span class="stat-value negative" id="total-fees">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Total Trading Costs</span>
                    <span class="stat-value negative" id="total-costs">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Cost per Trade</span>
                    <span class="stat-value" id="cost-per-trade">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Cost Impact</span>
                    <span class="stat-value negative" id="cost-impact">0%</span>
                </div>
            </div>

            <div class="col col-lg-4 col-md-6">
                <h3>Execution Quality</h3>
                <div class="stat-row">
                    <span class="stat-label">Average MFE (Max Favorable)</span>
                    <span class="stat-value positive" id="avg-mfe">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Average MAE (Max Adverse)</span>
                    <span class="stat-value negative" id="avg-mae">$0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">MFE/MAE Ratio</span>
                    <span class="stat-value positive" id="mfe-mae-ratio">0</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Efficiency Score</span>
                    <span class="stat-value positive" id="efficiency">0%</span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Exit Quality</span>
                    <span class="stat-value positive" id="exit-quality">0</span>
                </div>
            </div>
        </div>


        
    <div class="container-fluid py-4">
        <div class="row mb-4">
            <!-- Equity Curve -->
            <div class="col-lg-8">
                <div class="tv-card">
                    <div class="tv-card-header">
                        <i class="fas fa-chart-area me-2"></i>Equity Curve
                    </div>
                    <div class="tv-card-body">
                        <div class="chart-container">
                            <canvas id="equityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- P&L Distribution -->
            <div class="col-lg-4">
                <div class="tv-card">
                    <div class="tv-card-header">
                        <i class="fas fa-chart-bar me-2"></i>P&L Distribution
                    </div>
                    <div class="tv-card-body">
                        <div class="chart-container small">
                            <canvas id="pnlDistributionChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Time Analysis Tabs -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="tv-card">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#dailyTab" role="tab">
                                <i class="fas fa-calendar-day me-2"></i>Daily
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#monthlyTab" role="tab">
                                <i class="fas fa-calendar-alt me-2"></i>Monthly
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#weekdayTab" role="tab">
                                <i class="fas fa-calendar-week me-2"></i>By Weekday
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#hourlyTab" role="tab">
                                <i class="fas fa-clock me-2"></i>By Hour
                            </a>
                        </li>
                    </ul>
                    <div class="tab-content tv-tab-content">
                        <div class="tab-pane fade" id="dailyTab" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="dailyPnlChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="monthlyTab" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="monthlyPnlChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="weekdayTab" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="weekdayChart"></canvas>
                            </div>
                        </div>
                        <div class="tab-pane fade show active" id="hourlyTab" role="tabpanel">
                            <div class="chart-container">
                                <canvas id="hourlyChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Row -->
        <div class="row mb-4">
            <!-- Symbol Performance -->
            <div class="col-lg-6">
                <div class="tv-card">
                    <div class="tv-card-header">
                        <i class="fas fa-chart-pie me-2"></i>Top Symbols Performance
                    </div>
                    <div class="tv-card-body">
                        <div class="chart-container small">
                            <canvas id="symbolChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Hold Time Analysis -->
            <div class="col-lg-6">
                <div class="tv-card">
                    <div class="tv-card-header">
                        <i class="fas fa-stopwatch me-2"></i>Hold Time vs P&L
                    </div>
                    <div class="tv-card-body">
                        <div class="chart-container small">
                            <canvas id="holdTimeChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Size Analysis -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="tv-card">
                    <div class="tv-card-header">
                        <i class="fas fa-weight me-2"></i>Position Size Analysis
                    </div>
                    <div class="tv-card-body">
                        <div class="chart-container">
                            <canvas id="sizeAnalysisChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Loading charts...</p>
    </div>

    </div>
{% endblock %}
{% block scripts %}
    <script>
        
        // Sample data structure that matches the backend stats
        const statsData = JSON.parse('{{ stats|tojson|safe }}');


        // Tab functionality

        // Filter functions
        function applyFilters () {
            const filters = {
                start: document.getElementById('start-date').value,
                end: document.getElementById('end-date').value,
                strategy: document.getElementById('strategy').value,
                symbol: document.getElementById('symbol').value,
                side: document.getElementById('side').value,
                limit: document.getElementById('limit').value
            };

            // En una aplicación real, esto haría una petición al servidor
            window.location.href = `{{ url_for('journal_endpoints.performance') }}?start=${filters.start}&end=${filters.end}&strategy=${filters.strategy}&symbol=${filters.symbol}&side=${filters.side}&limit=${filters.limit}`;
        }

        async function resetFilters () {
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
            document.getElementById('strategy').value = '';
            document.getElementById('symbol').value = '';
            document.getElementById('side').value = '';
            document.getElementById('limit').value = '';

            applyFilters();
        }

        // Format currency values
        function formatCurrency (value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                minimumFractionDigits: 2
            }).format(value);
        }

        // Format percentage values
        function formatPercentage (value) {
            return new Intl.NumberFormat('en-US', {
                style: 'percent',
                minimumFractionDigits: 1,
                maximumFractionDigits: 2
            }).format(value / 100);
        }

        function formatNumber(n, mode=null, min_decimals=1, max_decimals=2) {
            if (mode === 'currency') {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: min_decimals,
                    maximumFractionDigits: max_decimals
                }).format(n);
            } else if (mode === 'percentage') {
                return new Intl.NumberFormat('en-US', {
                    style: 'percent',
                    minimumFractionDigits: min_decimals,
                    maximumFractionDigits: max_decimals
                }).format(n / 100);
            } else {
                return n.toFixed(decimals);
            }

        }

        // Simulate real data population
        async function populateStatsFromBackend (stats, mode='net') {
            document.getElementById('total-pnl').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.total_pnl) : formatCurrency(stats.gross?.total_pnl)}`;
            document.getElementById('total-pnl').className = 'value ' + (stats.net?.total_pnl > 0 ? 'positive' : 'negative');
            document.getElementById('win-rate').innerHTML = `${mode == 'net' ? formatPercentage(stats.net?.win_rate) : formatPercentage(stats.gross?.win_rate)}`;
            document.getElementById('total-trades').textContent = stats.total_trades;
            document.getElementById('risk-reward').innerHTML = `${mode == 'net' ? stats.net?.risk_reward.toFixed(2) : stats.gross?.risk_reward.toFixed(2)}`;
            document.getElementById('risk-reward').className = 'value ' + (stats.net?.risk_reward > 1 ? 'positive' : 'negative');

            
            document.getElementById('total-pnl-stat').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.total_pnl) : formatCurrency(stats.gross?.total_pnl)}`;
            document.getElementById('win-rate-stat').innerHTML = `${mode == 'net' ? formatPercentage(stats.net?.win_rate) : formatPercentage(stats.gross?.win_rate)}`;
            document.getElementById('total-trades-stat').textContent = stats.total_trades;

            document.getElementById('winning-trades').innerHTML = `${mode == 'net' ? stats.net?.winning_trades : stats.gross?.winning_trades}`;
            document.getElementById('losing-trades').innerHTML = `${mode == 'net' ? stats.net?.losing_trades : stats.gross?.losing_trades}`;
            document.getElementById('scratch-trades').innerHTML = `${mode == 'net' ? stats.net?.scratch_trades : stats.gross?.scratch_trades}`;

            document.getElementById('avg-trade').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.avg_trade_pnl) : formatCurrency(stats.gross?.avg_trade_pnl)}`;
            document.getElementById('avg-share').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.avg_pnl_per_share) : formatCurrency(stats.gross?.avg_pnl_per_share)}`;
            document.getElementById('median').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.median_trade_pnl) : formatCurrency(stats.gross?.median_trade_pnl)}`;
            document.getElementById('largest-gain').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.largest_gain) : formatCurrency(stats.gross?.largest_gain)}`;
            document.getElementById('largest-loss').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.largest_loss) : formatCurrency(stats.gross?.largest_loss)}`;

            document.getElementById('winning-pnl').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.winning_pnl) : formatCurrency(stats.gross?.winning_pnl)}`;
            document.getElementById('losing-pnl').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.losing_pnl) : formatCurrency(stats.gross?.losing_pnl)}`;
            document.getElementById('avg-win').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.avg_win) : formatCurrency(stats.gross?.avg_win)}`;
            document.getElementById('avg-loss').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.avg_loss) : formatCurrency(stats.gross?.avg_loss)}`;

            document.getElementById('risk-reward-stat').innerHTML = `${mode == 'net' ? stats.net?.risk_reward.toFixed(2) : stats.gross?.risk_reward.toFixed(2)}`;
            document.getElementById('profit-factor').innerHTML = `${mode == 'net' ? stats.net?.profit_factor.toFixed(2) : stats.gross?.profit_factor.toFixed(2)}`;
            document.getElementById('sharpe').innerHTML = `${mode == 'net' ? stats.net?.sharpe_ratio.toFixed(2) : stats.gross?.sharpe_ratio.toFixed(2)}`;
            document.getElementById('drawdown').innerHTML = `${mode == 'net' ? formatPercentage(stats.net?.max_drawdown) : formatPercentage(stats.gross?.max_drawdown)}`;
            document.getElementById('std').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.trade_pnl_std) : formatCurrency(stats.gross?.trade_pnl_std)}`;
            document.getElementById('sqn').innerHTML = `${mode == 'net' ? stats.net?.sqn.toFixed(2) : stats.gross?.sqn.toFixed(2)}`;

            document.getElementById('k-ratio').innerHTML = `${mode == 'net' ? stats.net?.k_ratio.toFixed(2) : stats.gross?.k_ratio.toFixed(2)}`;
            document.getElementById('kelly').innerHTML = `${mode == 'net' ? formatPercentage(stats.net?.kelly_percent) : formatPercentage(stats.gross?.kelly_percent)}`;
            document.getElementById('p-value').innerHTML = `${mode == 'net' ? stats.net?.p_value.toFixed(4) : stats.gross?.p_value.toFixed(4)}`;
            document.getElementById('avg-daily').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.avg_daily_pnl) : formatCurrency(stats.gross?.avg_daily_pnl)}`;
            document.getElementById('avg-volume').innerHTML = `${mode == 'net' ? formatCurrency(stats.net?.avg_daily_volume) : formatCurrency(stats.gross?.avg_daily_volume)}`;

            document.getElementById('max-wins').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_wins : stats.gross?.max_consecutive_wins}`;
            document.getElementById('max-losses').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_losses : stats.gross?.max_consecutive_losses}`;

            // General Stats Tab
            document.getElementById('total-commissions').textContent = formatCurrency(stats.total_commissions);
            document.getElementById('total-fees').textContent = formatCurrency(stats.total_fees);
            document.getElementById('total-costs').textContent = formatCurrency(stats.total_commissions + stats.total_fees);
            document.getElementById('cost-per-trade').textContent = formatCurrency((stats.total_commissions + stats.total_fees) / stats.total_trades);

            const costImpact = ((stats.gross?.total_pnl - stats.net?.total_pnl) / stats.gross?.total_pnl) * 100;
            document.getElementById('cost-impact').textContent = formatPercentage(costImpact);

            document.getElementById('hold-overall').textContent = stats.avg_hold_time_overall;
            document.getElementById('hold-winners').textContent = stats.avg_hold_time_winners;
            document.getElementById('hold-losers').textContent = stats.avg_hold_time_losers;
            document.getElementById('hold-scratches').textContent = stats.avg_hold_time_scratches;

            document.getElementById('avg-mfe').textContent = formatCurrency(stats.avg_mfe);
            document.getElementById('avg-mae').textContent = formatCurrency(stats.avg_mae);

            const mfeMaeRatio = Math.abs(stats.avg_mfe / stats.avg_mae);
            document.getElementById('mfe-mae-ratio').textContent = mfeMaeRatio.toFixed(2);

            document.getElementById('max-wins').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_wins : stats.gross?.max_consecutive_wins}`;
            document.getElementById('max-losses').innerHTML = `${mode == 'net' ? stats.net?.max_consecutive_losses : stats.gross?.max_consecutive_losses}`;

            // Apply color classes based on values
            applyColorClasses();
        }

        async function applyColorClasses () {
            // Apply positive/negative classes to values
            const elements = document.querySelectorAll('.stat-value');
            elements.forEach(el => {
                const text = el.textContent;
                if (text.includes('-') && !text.includes('ratio') && !text.includes('Ratio')) {
                    if (!el.classList.contains('negative')) {
                        el.classList.add('negative');
                    }
                } else if (text.includes('%') || text.includes('$')) {
                    const numValue = parseFloat(text.replace(/[^0-9.-]/g, ''));
                    if (numValue > 0) {
                        if (!el.classList.contains('positive')) {
                            el.classList.add('positive');
                        }
                    } else if (numValue < 0) {
                        if (!el.classList.contains('negative')) {
                            el.classList.add('negative');
                        }
                    }
                }
            });
        }

        async function changeGrossNet() {
            console.log('Gross/Net toggle changed');
            if (document.getElementById('gross-switch').checked) {
                // Switch to gross mode
                populateStatsFromBackend(statsData, 'gross');
                initializeCharts('gross');
            } else {
                // Switch to net mode
                populateStatsFromBackend(statsData, 'net');
                initializeCharts('net');
            }
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function () {
            // Set default date range (last 30 days)
            const endDate = new Date("{{ end }}");
            const startDate = new Date("{{ start}}");

            document.getElementById('start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('end-date').value = endDate.toISOString().split('T')[0];
            document.querySelector(`option[value="${ "{{ side or 'BOTH' }}" }"]`).selected = true;
            document.getElementById('symbol').value = "{{ asset_symbol }}" || '';
            document.getElementById('limit').value = "{{ limit }}" || '';

            // Load initial data with sample stats
            populateStatsFromBackend(statsData);

            // Add keyboard shortcuts
            document.addEventListener('keydown', function (e) {
                if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
                    applyFilters();
                }
            });
        });
        



        const chartsData = JSON.parse('{{ charts|tojson|safe }}');

        // Chart instances
        let charts = {};
        
        // Chart.js default config
        Chart.defaults.color = '#b0b0b0';
        Chart.defaults.backgroundColor = '#2d2d2d';
        Chart.defaults.borderColor = '#404040';

        // Global chart options
        const commonOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    labels: {
                        color: '#b0b0b0',
                        font: {
                            size: 12
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#b0b0b0' },
                    grid: { color: '#404040' }
                },
                y: {
                    ticks: { color: '#b0b0b0' },
                    grid: { color: '#404040' }
                }
            }
        };


        async function initializeCharts(mode='net') {

            const data = mode == 'gross' ? chartsData.gross : chartsData.net;

            showLoading(true);

            // Equity Curve
            if (charts.equity) {
                charts.equity.destroy();
            }
            const equityCtx = document.getElementById('equityChart').getContext('2d');
            charts.equity = new Chart(equityCtx, {
                type: 'line',
                data: {
                    labels: data.equity_curve?.dates,
                    datasets: [{
                        label: 'Cumulative P&L',
                        data: data.equity_curve?.equity,
                        borderColor: '#007cff',
                        backgroundColor: 'rgba(0, 124, 255, 0.1)',
                        fill: true,
                        tension: 0.1,
                        yAxisID: 'y'
                    }, {
                        label: 'DrawDown',
                        data: data.equity_curve?.drawdown,
                        borderColor: '#ff322d',
                        backgroundColor: 'rgba(0, 124, 255, 0.1)',
                        fill: true,
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: { color: '#b0b0b0' },
                            grid: { drawOnChartArea: false }
                        }
                    },
                    plugins: {
                        ...commonOptions.plugins,
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `P&L: $${context.parsed.y.toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });

            // P&L Distribution
            if (charts.pnlDist) {
                charts.pnlDist.destroy();
            }
            const pnlDistCtx = document.getElementById('pnlDistributionChart').getContext('2d');
            charts.pnlDist = new Chart(pnlDistCtx, {
                type: 'bar',
                data: {
                    labels: data.pnl_distribution?.bins,
                    datasets: [{
                        label: 'Trades',
                        data: data.pnl_distribution?.counts,
                        backgroundColor: function(context) {
                            const value = context.parsed.x;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Daily P&L
            if (charts.daily) {
                charts.daily.destroy();
            }
            const dailyCtx = document.getElementById('dailyPnlChart').getContext('2d');
            charts.daily = new Chart(dailyCtx, {
                type: 'bar',
                data: {
                    labels: data.daily_pnl?.dates,
                    datasets: [{
                        label: 'Daily P&L',
                        data: data.daily_pnl?.pnl,
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Monthly P&L
            if (charts.monthly) {
                charts.monthly.destroy();
            }
            const monthlyCtx = document.getElementById('monthlyPnlChart').getContext('2d');
            charts.monthly = new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: data.monthly_pnl?.months,
                    datasets: [{
                        label: 'Monthly P&L',
                        data: data.monthly_pnl?.pnl,
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Weekday Analysis
            if (charts.weekday) {
                charts.weekday.destroy();
            }
            const weekdayCtx = document.getElementById('weekdayChart').getContext('2d');
            charts.weekday = new Chart(weekdayCtx, {
                type: 'bar',
                data: {
                    labels: data.weekday_analysis?.days,
                    datasets: [{
                        label: 'Expectancy',
                        data: data.weekday_analysis?.expectancy,
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Hourly Analysis
            if (charts.hourly) {
                charts.hourly.destroy();
            }
            const hourlyCtx = document.getElementById('hourlyChart').getContext('2d');
            charts.hourly = new Chart(hourlyCtx, {
                type: 'bar',
                data: {
                    labels: data.hour_analysis?.hours.map(h => new Date(`1970-01-01 ${h}:00+00:00`).toLocaleString([], { hour: '2-digit', minute: '2-digit' })),
                    datasets: [{
                        label: 'Expectancy',
                        data: data.hour_analysis?.expectancy,
                        backgroundColor: function(context) {
                            const value = context.parsed.y;
                            return value > 0 ? '#00c851' : value < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: commonOptions
            });

            // Symbol Performance
            if (charts.symbol) {
                charts.symbol.destroy();
            }
            const symbolCtx = document.getElementById('symbolChart').getContext('2d');
            charts.symbol = new Chart(symbolCtx, {
                type: 'doughnut',
                data: {
                    labels: data.symbol_performance?.symbols,
                    datasets: [{
                        data: data.symbol_performance?.expectancy,
                        backgroundColor: [
                            '#007cff', '#00c851', '#ff4444', '#ffbb33', '#9c27b0',
                            '#e91e63', '#795548', '#607d8b', '#ff9800', '#4caf50'
                        ]
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {} // Remove scales for doughnut chart
                }
            });

            // Hold Time Analysis
            if (charts.holdTime) {
                charts.holdTime.destroy();
            }
            const holdTimeCtx = document.getElementById('holdTimeChart').getContext('2d');
            charts.holdTime = new Chart(holdTimeCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Trades', // TODO: Scatter without string x axis
                        data: data.hold_time_analysis?.hold_times.map((x, i) => ({ x: Math.round(x).toFixed(0) , y: data.hold_time_analysis?.pnl[i] })).sort((a, b) => Number(a.x) - Number(b.x)),
                        backgroundColor: function(context) {
                            const dataPoint = context.raw;
                            return dataPoint.y > 0 ? '#00c851' : dataPoint.y < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        x: {
                            ...commonOptions.scales.x,
                            title: {
                                display: true,
                                text: 'Hold Time (hours)',
                                color: '#b0b0b0'
                            }
                        },
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: 'P&L ($)',
                                color: '#b0b0b0'
                            }
                        }
                    }
                }
            });

            // Size Analysis
            if (charts.size) {
                charts.size.destroy();
            }
            const sizeCtx = document.getElementById('sizeAnalysisChart').getContext('2d');
            charts.size = new Chart(sizeCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Trades', // TODO: Scatter without string x axis
                        data: data.size_analysis?.sizes.map((x, i) => ({ x: Math.round(x).toFixed(0) , y: data.size_analysis?.pnl[i] })).sort((a, b) => Number(a.x) - Number(b.x)),
                        backgroundColor: function(context) {
                            const dataPoint = context.raw;
                            return dataPoint.y > 0 ? '#00c851' : dataPoint.y < 0 ? '#ff4444' : '#b0b0b0';
                        }
                    }]
                },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        x: {
                            ...commonOptions.scales.x,
                            title: {
                                display: true,
                                text: 'Position Size',
                                color: '#b0b0b0'
                            }
                        },
                        y: {
                            ...commonOptions.scales.y,
                            title: {
                                display: true,
                                text: 'P&L ($)',
                                color: '#b0b0b0'
                            }
                        }
                    }
                }
            });
        
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initializeCharts('net');
        });

    </script>
{% endblock %}