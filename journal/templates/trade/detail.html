{% extends "base.html" %}

{% block style %}
<link href="{{ url_for('static', filename='css/chart.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-body text-center">
        <div class="trade-symbol" id="tradeSymbol"></div>
        <div class="trade-subtitle" id="tradeSubtitle"></div>
        <div class="trade-pnl" id="tradePnl"></div>
    </div>
</div>
<div class="d-flex justify-content-center gap-3 mt-2">
    <button class="btn btn-pill bg-primary" onclick="editTrade()">‚úèÔ∏è Edit</button>
    <button class="btn btn-pill bg-danger" onclick="deleteTrade()">üóëÔ∏è Delete</button>
</div>

<div class="main-content">
    <div class="left-column">
        <!-- Informaci√≥n B√°sica -->
        <div class="card">
            <h3 class="card-header">
                Informaci√≥n de la Operaci√≥n
            </h3>
            <div class="card-body">
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Fecha de Entrada</div>
                        <div class="info-value" id="entryDate"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Hora de Entrada (UTC)</div>
                        <div class="info-value" id="entryTime"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Precio de Entrada</div>
                        <div class="info-value" id="entryPrice"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Fecha de Salida</div>
                        <div class="info-value" id="exitDate"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Hora de Salida (UTC)</div>
                        <div class="info-value" id="exitTime"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Precio de Salida</div>
                        <div class="info-value" id="exitPrice"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Balance</div>
                        <div class="info-value" id="balance"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Stop Loss</div>
                        <div class="info-value" id="stopLoss"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Take Profit</div>
                        <div class="info-value" id="takeProfit"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Cantidad</div>
                        <div class="info-value" id="quantity"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Cantidad Pendiente</div>
                        <div class="info-value" id="pendingQuantity"></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Comisi√≥n</div>
                        <div class="info-value" id="commission"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultado -->
        <div class="card">
            <div class="card-header success">
                üí∞ Resultado de la Operaci√≥n
            </div>
            <div class="card-body">
                <div class="stat-row">
                    <span class="stat-label">Profit/Loss</span>
                    <span class="stat-value" id="profitLoss"></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Rendimiento</span>
                    <span class="stat-value" id="return"></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Estrategia</span>
                    <span class="stat-value" id="strategy"></span>
                </div>
                <div class="stat-row">
                    <span class="stat-label">Duraci√≥n</span>
                    <span class="stat-value" id="duration"></span>
                </div>
            </div>
        </div>

        <!-- An√°lisis y Notas -->
        <div class="card">
            <div class="card-header info">
                üìù An√°lisis y Notas
            </div>
            <div class="card-body">
                <div class="info-item">
                    <div class="info-label">Descripci√≥n</div>
                    <div class="info-value" id="description"></div>
                </div>

                <div class="info-item">
                    <div class="info-label">Por qu√© fue rentable</div>
                    <div class="info-value" id="whyProfitable"></div>
                </div>

                <div class="info-item">
                    <div class="info-label">Factores influyentes</div>
                    <div class="info-value" id="influencingFactors"></div>
                </div>

                <div class="hashtags" id="hashtags">
                </div>
            </div>
        </div>

        <!-- Transacciones -->
        <div class="card">
            <div class="card-header warning">
                üîÑ Historial de Transacciones
            </div>
            <div class="card-body pb-2">
                <div id="transactionsList">
                </div>
            </div>
        </div>
    </div>

    <div class="right-column">
        <!-- Scoring/Criterios -->
        <div class="card">
            <div class="card-header">
                ‚≠ê Evaluaci√≥n por Criterios
            </div>
            <div class="card-body">
                <div id="scoringList">
                </div>
            </div>
        </div>

        <!-- Errores -->
        <div class="card">
            <div class="card-header danger">
                ‚ö†Ô∏è Errores Identificados <span id="errorsNumber"></span>
            </div>
            <div class="card-body">
                <div id="errorsList">
                </div>
            </div>
        </div>

        <!-- Media/Screenshots -->
        <div class="card">
            <div class="card-header info">
                üì∏ Screenshots y Media
            </div>
            <div class="card-body">
                <div class="media-gallery" id="mediaGallery">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Stock chart -->
<div id="chartCard" class="">
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='chart.js') }}"></script>
<script>
    // Sample trade data - replace with real data from your backend
    const tradeData = JSON.parse('{{ trade_data|tojson }}');
    window.tradeData = tradeData;
    window.candleData = tradeData['candles'];
    window.transactionData = tradeData['transactions'];

    function loadTradeData () {
        // Load basic trade info
        document.getElementById('tradeSymbol').textContent = tradeData.symbol;
        document.getElementById('tradeSubtitle').textContent =
            `${tradeData.company_name} - Operaci√≥n ${tradeData.trade_type}`;

        // Calculate and display profit/loss
        const pnlPercent = ((tradeData.profit_loss / (tradeData.entry_price * tradeData.quantity)) * 100).toFixed(2); // TODO: Calculate the return correctly and with last asset price
        const tradePnl = document.getElementById('tradePnl');
        tradePnl.textContent = `${tradeData.profit_loss >= 0 ? '+' : ''}$${tradeData.profit_loss.toFixed(2)} (${pnlPercent}%)`;
        const pnlParent = tradePnl.parentElement
        pnlParent.classList.add(tradeData.profit_loss > 0 ? 'bg-success' : tradeData.profit_loss < 0 ? 'bg-danger' : 'bg-warning');
        const pnlGranParent = pnlParent.parentElement;
        pnlGranParent.classList.add(tradeData.profit_loss > 0 ? 'bg-success' : tradeData.profit_loss < 0 ? 'bg-danger' : 'bg-warning');

        // Load trade details
        document.getElementById('entryDate').textContent = tradeData.entry_date || '';
        document.getElementById('entryTime').textContent = tradeData.entry_time || '';
        document.getElementById('entryPrice').textContent = `$${tradeData.entry_price?.toFixed(2)}`;
        document.getElementById('exitDate').textContent = tradeData.exit_date || '';
        document.getElementById('exitTime').textContent = tradeData.exit_time || '';
        document.getElementById('exitPrice').textContent = `$${tradeData.exit_price?.toFixed(2)}`;
        document.getElementById('stopLoss').textContent = `$${tradeData.stop_loss?.toFixed(2)}`;
        document.getElementById('takeProfit').textContent = `$${tradeData.take_profit?.toFixed(2)}`;
        document.getElementById('quantity').textContent = tradeData.quantity ? `${tradeData.quantity} acciones` : '';
        document.getElementById('pendingQuantity').textContent = tradeData.quantity && tradeData.exit_quantity ? `${tradeData.exit_quantity - tradeData.quantity} acciones` : '';
        document.getElementById('balance').textContent = `$${tradeData.balance?.toFixed(2)}`;
        document.getElementById('commission').textContent = `$${tradeData.commission?.toFixed(2)}`;

        // Load result info
        document.getElementById('profitLoss').textContent = tradeData.profit_loss ? `${tradeData.profit_loss >= 0 ? '+' : '-'}$${tradeData.profit_loss.toFixed(2)}` : '';
        document.getElementById('profitLoss').className = tradeData.profit_loss ? `stat-value ${tradeData.profit_loss >= 0 ? 'positive' : 'negative'}` : '';
        document.getElementById('return').textContent = `${pnlPercent >= 0 ? '+' : ''}${pnlPercent}%`;
        document.getElementById('return').className = `stat-value ${pnlPercent >= 0 ? 'positive' : 'negative'}`;
        document.getElementById('strategy').textContent = tradeData.strategy?.name;

        // Calculate duration
        if (tradeData.entry_date && tradeData.exit_date) {
            const entryDateTime = new Date(`${tradeData.entry_date}T${tradeData.entry_time}`);
            const exitDateTime = new Date(`${tradeData.exit_date}T${tradeData.exit_time}`);
            const duration = exitDateTime - entryDateTime;
            const hours = Math.floor(duration / (1000 * 60 * 60));
            const minutes = Math.floor((duration % (1000 * 60 * 60)) / (1000 * 60));
            document.getElementById('duration').textContent = `${hours}h ${minutes}min`;
        }

        // Load analysis
        if (tradeData.description) {
            document.getElementById('description').innerHTML = tradeData.description;
        } else {
            document.getElementById('description').parentElement.remove();
        }

        if (tradeData.why_profitable) {
            document.getElementById('whyProfitable').innerHTML = tradeData.why_profitable;
        } else {
            document.getElementById('whyProfitable').parentElement.remove();
        }

        if (tradeData.influencing_factors) {
            document.getElementById('influencingFactors').innerHTML = tradeData.influencing_factors;
        } else {
            document.getElementById('influencingFactors').parentElement.remove();
        }

        // Load hashtags
        const hashtagsContainer = document.getElementById('hashtags');
        const hashtags = tradeData.hashtags;
        if (hashtags.length > 0) {
            hashtagsContainer.innerHTML = '';
            hashtags.split(',').forEach(hashtag => {
                const hashtagElement = document.createElement('span');
                hashtagElement.className = 'hashtag rounded bg-info';
                hashtagElement.textContent = hashtag.trim();
                hashtagsContainer.appendChild(hashtagElement);
            });
        } else {
            hashtagsContainer.remove();
        }

        // Load scoring
        loadScoring();

        // Load errors
        loadErrors();

        // Load transactions
        loadTransactions();
    }

    function loadScoring () {
        const scoringContainer = document.getElementById('scoringList');
        scoringContainer.innerHTML = '';

        let totalScore = 0;
        let totalMaxPoints = 0;

        tradeData.strategy.conditions.forEach(condition => {
            const checked = tradeData.conditions.find(obj => obj.scoring_id === parseInt(condition.id));

            const scoringItem = document.createElement('div');
            scoringItem.className = 'card mb-3 shadow-none scoring-item';
            scoringItem.innerHTML = `
                    <div class="p-1">
                        <div class="scoring-name">${condition.name}</div>
                        <div class="scoring-description">${condition.description}</div>
                    </div>
                    <div class="rounded bg-primary p-2 scoring-value">${checked ? checked.value : 0.0}/${condition.score}</div>
                `;
            scoringContainer.appendChild(scoringItem);

            totalScore += checked ? checked.value : 0;
            totalMaxPoints += condition.score;
        });

        // Add total score
        const totalScoreDiv = document.createElement('div');
        totalScoreDiv.className = 'card shadow-none final-score';
        totalScoreDiv.innerHTML = `
                <div class="info-label">Puntuaci√≥n Total Ponderada</div>
                <div class="score ${totalScore / totalMaxPoints < 0.5 ? 'text-loss' : 'text-profit'}">${(totalScore / totalMaxPoints * 100).toFixed(0)}%</div>
            `;
        scoringContainer.appendChild(totalScoreDiv);
    }

    function loadErrors () {
        const errorsContainer = document.getElementById('errorsList');
        errorsContainer.innerHTML = '';

        if (tradeData.errors.length === 0) {
            errorsContainer.innerHTML = '<div class="no-data">No se identificaron errores en esta operaci√≥n</div>';
            return;
        }
        document.getElementById('errorsNumber').innerHTML = `(${tradeData.errors.length})`;
        tradeData.errors.forEach(error => {
            const errorItem = document.createElement('div');
            errorItem.className = 'card shadow-none error-item';
            const severityClass = error.severity == 'low' ? 'bg-info' : error.severity == 'medium' ? 'bg-warning' : 'bg-danger' ;
            errorItem.innerHTML = `
                    <div class="error-header">
                        <div class="error-description">${error.description}</div>
                        <span class="severity-badge rounded ${severityClass}">${error.severity.charAt(0).toUpperCase() + error.severity.slice(1)}</span>
                    </div>
                    <div class="error-meta text-muted">Categor√≠a: ${error.category} | Detectado el ${tradeData.entry_date}</div>
                `;
            errorsContainer.appendChild(errorItem);
        });
    }

    function loadTransactions () {
        const transactionsContainer = document.getElementById('transactionsList');
        transactionsContainer.innerHTML = '';

        tradeData.transactions.forEach(transaction => {
            const transactionItem = document.createElement('div');
            transactionItem.className = 'card shadow-none transaction-item mb-2';

            const amount = transaction.type === 'LONG'
                ? -(transaction.quantity * transaction.price + transaction.commission)
                : (transaction.quantity * transaction.price - transaction.commission);

            const amountClass = amount >= 0 ? 'text-profit' : 'text-loss';
            const transactionTypeText = transaction.type === 'LONG' ? 'Buy' : 'Sell';

            // Format date
            const date = new Date(transaction.date);
            const formattedDate = date.toLocaleDateString('en-US', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            });

            transactionItem.innerHTML = `
                    <div>
                        <div class="transaction-date">${formattedDate} - ${transaction.time}</div>
                        <div class="transaction-details text-muted">${transactionTypeText}: ${transaction.quantity} acciones a ${transaction.price.toFixed(2)} - Comisi√≥n: ${transaction.commission.toFixed(2)}</div>
                    </div>
                    <div class="transaction-amount ${amountClass}">${amount >= 0 ? '+' : '-'}${Math.abs(amount).toFixed(2)}</div>
                `;
            transactionsContainer.appendChild(transactionItem);
        });
    }

    // Action buttons functionality
    function goBack () {
        if (window.history.length > 1) {
            window.history.back();
        } else {
            // Redirect to trades list or dashboard
            window.location.href = '/trades';
        }
    }

    function editTrade () {
        window.location.href = `{{ url_for('journal_endpoints.edit_trade', trade_id=0) }}`.replace('0', tradeData.id);
    }

    async function deleteTrade () {
        if (confirm('¬øEst√°s seguro de que quieres borrar este trade?')) {
            const url = `{{ url_for('journal_endpoints.delete_trade', trade_id=0) }}`.replace('0', tradeData.id);
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                if (response.redirected) {
                    window.location.href = response.url;
                } else {
                    // Si no hay redirecci√≥n, recarga la p√°gina
                    window.location.reload();
                }
            } catch (error) {
                alert('Error al borrar el trade');
            }
        }
    }

    // Media gallery functionality
    function initializeMediaGallery () {
        const mediaGallery = document.getElementById('mediaGallery');
        mediaGallery.innerHTML = '';

        if (tradeData.media.length === 0) {
            mediaGallery.innerHTML = '<div class="no-data">No hay screenshots disponibles para este trade</div>';
            return;
        }

        tradeData.media.forEach((media, index) => {
            const mediaItem = document.createElement('div');
            mediaItem.className = 'media-item rounded';

            // Detecta si es video por la extensi√≥n (incluye mkv)
            const isVideo = media.url.match(/\.(mp4|webm|ogg|mkv)$/i);

            if (isVideo) {
                let url = "{{ url_for('serve_media', filename='0') }}".replace('0', media.url);
                mediaItem.innerHTML = `
                        <video src="${url}" controls width="100%" height="120" style="object-fit:cover;" poster="${media.poster || ''}">
                            Tu navegador no soporta video.
                        </video>
                    `;
                mediaItem.addEventListener('click', () => {
                    window.open(media.url, '_blank');
                });
            } else {
                mediaItem.innerHTML = `
                        <img src="${media.url}" alt="Screenshot ${index + 1}">
                    `;
                mediaItem.addEventListener('click', () => {
                    window.open(media.url, '_blank');
                });
            }

            mediaGallery.appendChild(mediaItem);
        });
    }

    // Utility functions
    function calculateRiskRewardRatio () {
        const risk = Math.abs(tradeData.entry_price - tradeData.stop_loss);
        const reward = Math.abs(tradeData.take_profit - tradeData.entry_price);
        return reward / risk;
    }

    // Initialize everything when page loads
    document.addEventListener('DOMContentLoaded', function () {
        loadTradeData();
        initializeMediaGallery();

        // Add some additional info that might be useful
        console.log('Trade loaded:', tradeData);
        console.log('Risk/Reward Ratio:', calculateRiskRewardRatio().toFixed(2));
    });
</script>

<script>
    // Inicializar la aplicaci√≥n
    let chart;

    // Funci√≥n para inicializar con datos externos
    function initializeChart (candleData = null, globalTransactionData = null) {
        console.log(globalTransactionData);
        if (chart) {
            // Si ya existe un chart, actualizarlo con nuevos datos
            if (candleData) {
                chart.loadData(candleData, globalTransactionData);
            } else {
                chart.generateData();
            }
            chart.reset();
            chart.drawCharts();
        } else {
            // Crear nuevo chart
            chart = new TradingChart(document.getElementById('chartCard'), candleData['1d'], candleData['1m'], globalTransactionData, { startReplay: window.tradeData.entry_date + 'T' + window.tradeData.entry_time });
        }
    }

    document.addEventListener('DOMContentLoaded', function () {
        initializeChart(window.candleData || null, window.transactionData || null);
    });

    // Exportar funciones para uso global si es necesario
    window.TradingChart = TradingChart;
    window.initializeChart = initializeChart;
</script>
{% endblock %}