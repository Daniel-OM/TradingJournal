
{% extends "base.html" %}

{% block style %}
<style>
    .container {
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="header">
    <h1>üìà Calendario de Trading</h1>
    <p>Seguimiento diario de tus operaciones</p>
    <a href="{{ url_for('journal_endpoints.add_trade') }}" class="btn btn-primary">
        <i class="fas fa-plus me-2"></i>A√±adir Trade
    </a>
</div>

<div class="calendar-nav">
    <button class="nav-btn" onclick="changeMonth(-1)">‚Üê Mes Anterior</button>
    <div class="current-month" id="currentMonth"></div>
    <button class="nav-btn" onclick="changeMonth(1)">Siguiente Mes ‚Üí</button>
</div>

<div class="calendar">
    <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar will be generated here -->
    </div>
</div>

<!-- Modal -->
<div id="tradesModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modalTitle">Trades del d√≠a</h2>
            <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="summary" id="daySummary">
                <!-- Summary will be generated here -->
            </div>
            <div id="tradesList">
                <!-- Trades list will be generated here -->
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
    <script>
        let tradingData = {};
        let currentDate = new Date();
        const monthNames = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        const dayNames = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];

        function getLocalDateString(date=null) {
            if (!date) {
                date = currentDate;
            }
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function getData() {
            // Usa la fecha actual del calendario
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth() + 1; // JS: 0-indexed, Python: 1-indexed
            const day = 1;
            const dateStr = getLocalDateString(currentDate);

            try {
                const response = await fetch(`{{ url_for('journal_endpoints.month_trades', date=0) }}`.replace('0', dateStr));
                if (!response.ok) throw new Error('Error al obtener los trades');
                const trades = await response.json();

                // Organiza los trades por fecha (usa exit_date o la propiedad que corresponda)
                tradingData = {};
                trades.forEach(trade => {
                    const dateKey = trade.exit_date; // Aseg√∫rate que tu to_dict() devuelva exit_date en formato 'YYYY-MM-DD'
                    if (!tradingData[dateKey]) tradingData[dateKey] = [];
                    tradingData[dateKey].push({
                        id: trade.id,
                        symbol: trade.symbol,
                        type: trade.trade_type,
                        entry: trade.entry_price,
                        exit: trade.exit_price,
                        quantity: trade.quantity,
                        pnl: trade.profit_loss,
                        time: trade.exit_time // o la propiedad de hora que uses
                    });
                });
                generateCalendar();
            } catch (error) {
                console.error(error);
                tradingData = {};
            }
        }

        function generateCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                `${monthNames[month]} ${year}`;

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());

            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';

            // Add day headers
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header';
                dayHeader.textContent = day;
                calendarGrid.appendChild(dayHeader);
            });

            // Generate calendar days
            const today = new Date();
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                if (cellDate.getMonth() !== month) {
                    dayCell.classList.add('other-month');
                }

                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.classList.add('today');
                }

                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = cellDate.getDate();
                dayCell.appendChild(dayNumber);

                // Add profit/loss data
                const dateKey = getLocalDateString(cellDate);
                const dayTrades = tradingData[dateKey] || [];
                if (dayTrades.length > 0) {
                    const totalPnL = dayTrades.reduce((sum, trade) => sum + trade.pnl, 0);
                    const pnlElement = document.createElement('div');
                    pnlElement.className = 'profit-loss';
                    
                    if (totalPnL > 0) {
                        pnlElement.classList.add('profit');
                        pnlElement.textContent = `+$${totalPnL.toFixed(2)}`;
                    } else if (totalPnL < 0) {
                        pnlElement.classList.add('loss');
                        pnlElement.textContent = `-$${Math.abs(totalPnL).toFixed(2)}`;
                    } else {
                        pnlElement.classList.add('breakeven');
                        pnlElement.textContent = '$0.00';
                    }
                    
                    dayCell.appendChild(pnlElement);
                    dayCell.style.cursor = 'pointer';
                    dayCell.onclick = () => showTradesModal(cellDate, dayTrades);
                }
                console.log(dayCell);
                calendarGrid.appendChild(dayCell);
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            getData();
        }

        function showTradesModal(date, trades) {
            const modal = document.getElementById('tradesModal');
            const modalTitle = document.getElementById('modalTitle');
            const daySummary = document.getElementById('daySummary');
            const tradesList = document.getElementById('tradesList');

            modalTitle.textContent = `Trades del ${date.getDate()} de ${monthNames[date.getMonth()]} ${date.getFullYear()}`;

            // Generate summary
            const totalPnL = trades.reduce((sum, trade) => sum + trade.pnl, 0);
            const winningTrades = trades.filter(trade => trade.pnl > 0).length;
            const losingTrades = trades.filter(trade => trade.pnl < 0).length;

            daySummary.innerHTML = `
                <div class="summary-item">
                    <div class="summary-label">Total P&L</div>
                    <div class="summary-value" style="color: ${totalPnL >= 0 ? '#28a745' : '#dc3545'}">
                        ${totalPnL >= 0 ? '+' : ''}$${totalPnL.toFixed(2)}
                    </div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Trades Ganadores</div>
                    <div class="summary-value" style="color: #28a745">${winningTrades}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Trades Perdedores</div>
                    <div class="summary-value" style="color: #dc3545">${losingTrades}</div>
                </div>
                <div class="summary-item">
                    <div class="summary-label">Total Trades</div>
                    <div class="summary-value">${trades.length}</div>
                </div>
            `;

            // Generate trades list
            if (trades.length === 0) {
                tradesList.innerHTML = '<div class="no-trades">No hay trades para este d√≠a</div>';
            } else {
                tradesList.innerHTML = trades.map(trade => `
                    <div class="trade-item ${trade.pnl >= 0 ? 'profit' : 'loss'}" onclick="goToTradeDetails(${trade.id})">
                        <div class="trade-info">
                            <div class="trade-symbol">${trade.symbol} - ${trade.type}</div>
                            <div class="trade-details">
                                ${trade.time} | Entrada: $${trade.entry} ‚Üí Salida: $${trade.exit} | Cantidad: ${trade.quantity}
                            </div>
                        </div>
                        <div class="trade-pnl" style="color: ${trade.pnl >= 0 ? '#28a745' : '#dc3545'}">
                            ${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}
                        </div>
                        <div class="trade-actions" onclick="event.stopPropagation()">
                            <button class="btn btn-edit" onclick="editTrade(${trade.id})">Editar</button>
                            <button class="btn btn-delete" onclick="deleteTrade(${trade.id})">Borrar</button>
                        </div>
                    </div>
                `).join('');
            }

            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('tradesModal').style.display = 'none';
        }

        function goToTradeDetails(tradeId) {
            // Simulate navigation to trade details page
            // alert(`Navegando a los detalles del trade ID: ${tradeId}`);
            window.location.href = `{{ url_for('journal_endpoints.get_trade', id=0) }}`.replace('0', tradeId);
        }

        function editTrade(tradeId) {
            // alert(`Editando trade ID: ${tradeId}`);
            window.location.href = `{{ url_for('journal_endpoints.edit_trade', trade_id=0) }}`.replace('0', tradeId);
        }
        
        async function deleteTrade(tradeId) {
            if (confirm('¬øEst√°s seguro de que quieres borrar este trade?')) {
                const url = `{{ url_for('journal_endpoints.delete_trade', trade_id=0) }}`.replace('0', tradeId);
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/x-www-form-urlencoded'
                        }
                    });
                    if (response.redirected) {
                        window.location.href = response.url;
                    } else {
                        // Si no hay redirecci√≥n, recarga la p√°gina
                        window.location.reload();
                    }
                } catch (error) {
                    alert('Error al borrar el trade');
                }
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('tradesModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize calendar
            getData();
        });

    </script>
{% endblock %}